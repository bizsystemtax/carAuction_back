<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="FineMngeDAO">
	<resultMap id="ComnCdVO" type="egovframework.penalty.ComnCdVO">
		<result property="comnCdEngNm" column="COMN_CD_ENG_NM"/>
		<result property="cdNm" column="CD_NM"/>
		<result property="cdVal" column="CD_VAL"/>
	</resultMap>
	
	<resultMap id="FineMngeVO" type="egovframework.penalty.FineMngeVO">
		<result property="inVltDtStrt" column="IN_VLT_DT_STRT"/>
		<result property="inVltDtEnd" column="IN_VLT_DT_END"/>
		<result property="inVltKindCd" column="IN_VLT_KIND_CD"/>
		<result property="inSendPlcCd" column="IN_SEND_PLC_CD"/>
		<result property="inGdCd" column="IN_GD_CD"/>
		<result property="inCsNm" column="IN_CS_NM"/>
		<result property="inVhclNo" column="IN_VHCL_NO"/>
		<result property="id" column="ID"/>
		<result property="gdNm" column="GD_NM"/>
		<result property="csNm" column="CS_NM"/>
		<result property="vhclNo" column="VHCL_NO"/>
		<result property="vltDt" column="VLT_DT"/>
		<result property="vltAtime" column="VLT_ATIME"/>
		<result property="fineSeq" column="FINE_SEQ"/>
		<result property="fineUploadNm" column="FINE_UPLOAD_NM"/>
		<result property="cfmtStatNm" column="CFMT_STAT_NM"/>
		<result property="cfmtDt" column="CFMT_DT"/>
		<result property="sendPlcNm" column="SEND_PLC_NM"/>
		<result property="sendPlcSeq" column="SEND_PLC_SEQ"/>
		<result property="sendPlcDeptNm" column="SEND_PLC_DEPT_NM"/>
		<result property="vltKindCd" column="VLT_KIND_CD"/>
		<result property="vltKindNm" column="VLT_KIND_NM"/>
		<result property="vltCts" column="VLT_CTS"/>
		<result property="vltPnt" column="VLT_PNT"/>
		<result property="fineAmt" column="FINE_AMT"/>
		<result property="pymtDdayDt" column="PYMT_DDAY_DT"/>
		<result property="rcptDt" column="RCPT_DT"/>
		<result property="pymtDt" column="PYMT_DT"/>
		<result property="drvrChgeYn" column="DRVR_CHGE_YN"/>
		<result property="drvrChgeDt" column="DRVR_CHGE_DT"/>
		<result property="loanStatNm" column="LOAN_STAT_NM"/>
		<result property="loanNo" column="LOAN_NO"/>
		<result property="loanSeq" column="LOAN_SEQ"/>
		<result property="vltKindCdKey1" column="VLT_KIND_CD_KEY1"/>
		<result property="vltKindCdKey2" column="VLT_KIND_CD_KEY2"/>
		<result property="userId" column="USER_ID"/>
		<result property="userIp" column="USER_IP"/>
	</resultMap>
	
	<!-- Retrieve : 범칙금관리 검색조건 콤보박스 조회 -->
	<select id="retrieveComboBoxList" resultMap="ComnCdVO">
		<![CDATA[
		SELECT	COMN_CD_ENG_NM /*공통코드영문명*/
				, CD_VAL /*코드값*/
				, CD_NM /*코드명*/
		FROM	BIZ_COMN_CD_DTL /*BIZ_공통코드상세*/
		WHERE	COMN_CD_ENG_NM = 'VLT_KIND_CD'
		UNION ALL
		SELECT	COMN_CD_ENG_NM /*공통코드영문명*/
				, CD_VAL /*코드값*/
				, CD_NM /*코드명*/
		FROM	BIZ_COMN_CD_DTL /*BIZ_공통코드상세*/
		WHERE	COMN_CD_ENG_NM = 'FINE_UPLOAD_CD'
		UNION ALL
		SELECT	'SEND_PLC_CD' AS COMN_CD_ENG_NM /*공통코드영문명(발송처코드)*/
				, A.SEND_PLC_CD AS CD_VAL /*발송처코드*/
				, A.NTCDOC_SEND_PLC_NM AS CD_NM /*고지서발송처명*/
		FROM	BIZ_FINE_SEND_PLC_STD_MNGE A /*BIZ_범칙금발송처기준관리*/
		WHERE 	A.SEND_PLC_SEQ = (SELECT MIN(SEND_PLC_SEQ)
								  FROM BIZ_FINE_SEND_PLC_STD_MNGE X 
								  WHERE A.SEND_PLC_CD = X.SEND_PLC_CD)
		]]>
	</select>
	
	<!-- Retrieve : 범칙금관리 목록 조회 -->
	<select id="retrieveFineMnge" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	ROW_NUMBER() OVER (ORDER BY A.VLT_DT DESC, A.VLT_ATIME DESC, A.FINE_SEQ) AS ID /*순번*/
				, CASE WHEN B.GD_CD LIKE 'RC%' THEN '렌터카' ELSE '리스' END AS GD_NM /*상품명*/
				, B.CS_NM /*고객명*/
				, A.VHCL_NO /*차량번호*/
				, A.VLT_DT /*위반일자*/
				, A.VLT_ATIME /*위반시각*/
				, A.FINE_SEQ /*범칙금일련번호*/
				, (SELECT X.CD_NM FROM BIZ_COMN_CD_DTL X WHERE X.COMN_CD_ENG_NM = 'FINE_UPLOAD_CD' AND X.CD_VAL = A.FINE_UPLOAD_CD) AS FINE_UPLOAD_NM /*범칙금업로드명*/
				, CASE WHEN A.CFMT_DT != '' THEN '확정' ELSE '미확정' END AS CFMT_STAT_NM /*확정상태명*/
				, A.CFMT_DT /*확정일자*/
				, C.SEND_PLC_CD AS SEND_PLC_CD /*발송처코드*/
				, C.NTCDOC_SEND_PLC_NM AS SEND_PLC_NM /*발송처명*/
				, C.SEND_PLC_SEQ AS SEND_PLC_SEQ /*발송처일련번호*/
				, C.NTCDOC_SEND_PLC_DEPT_NM AS SEND_PLC_DEPT_NM /*발송처부서명*/
				, A.VLT_KIND_CD AS VLT_KIND_CD /*위반종류코드*/
				, (SELECT X.CD_NM FROM BIZ_COMN_CD_DTL X WHERE X.COMN_CD_ENG_NM = 'VLT_KIND_CD' AND X.CD_VAL = A.VLT_KIND_CD) AS VLT_KIND_NM /*위반종류명*/
				, A.VLT_CTS  /*위반내용*/
				, A.VLT_PNT  /*위반장소*/
				, A.FINE_AMT /*범칙금금액*/
				, A.PYMT_DDAY_DT /*납부기한일자*/
				, A.RCPT_DT /*접수일자*/
				, A.PYMT_DT /*납입일자*/
				, CASE WHEN A.DRVR_CHGE_DT != '' THEN 'Y' ELSE 'N' END AS DRVR_CHGE_YN /*운전자변경여부*/
				, A.DRVR_CHGE_DT /*운전자변경일*/
				, (SELECT X.CD_NM FROM BIZ_COMN_CD_DTL X WHERE X.COMN_CD_ENG_NM = 'LOAN_STAT_CD' AND X.CD_VAL = B.LOAN_STAT_CD) AS LOAN_STAT_NM /*대출상태명*/
		FROM 	BIZ_FINE_MAS A 
				, BIZ_LOAN_MAS B 
				, BIZ_FINE_SEND_PLC_STD_MNGE C 
		WHERE 	A.VHCL_NO = B.VHCL_NO 
		AND 	A.VLT_DT >= B.LOAN_DT
		AND 	(A.VLT_DT < B.TMNT_DT OR B.TMNT_DT = '')
		AND 	A.SEND_PLC_CD = C.SEND_PLC_CD 
		AND 	A.SEND_PLC_SEQ = C.SEND_PLC_SEQ
		AND		A.VLT_DT BETWEEN #{inVltDtStrt} AND #{inVltDtEnd} /*검색조건-위반일자*/
		]]>
		<!-- 위반종류코드 -->
		<if test="inVltKindCd != null and inVltKindCd != ''">
		AND		A.VLT_KIND_CD = #{inVltKindCd}
		</if>
		<!-- 발송처코드 -->
		<if test="inSendPlcCd != null and inSendPlcCd != ''">
		AND		A.SEND_PLC_CD = #{inSendPlcCd}
		</if>
		<!-- 상품코드(X) -->
		<if test="inGdCd == 99">
		AND		B.GD_CD = NULL
		</if>
		<!-- 상품코드(리스) -->
		<if test="inGdCd == 1">
		AND		B.GD_CD NOT LIKE 'RC%'
		</if>
		<!-- 상품코드(렌터카) -->
		<if test="inGdCd == 2">
		AND		B.GD_CD LIKE 'RC%'
		</if>
		<!-- 고객명 -->
		<if test="inCsNm != null and inCsNm != ''">
		AND		B.CS_NM = #{inCsNm}
		</if>
		<!-- 차량번호 -->
		<if test="inVhclNo != null and inVhclNo != ''">
		AND		A.VHCL_NO = #{inVhclNo}
		</if>
		<!-- 위반시각(유효성) -->
		<if test="vltAtime != null and vltAtime != ''">
		AND		A.VLT_ATIME = #{vltAtime}
		</if>
		<!-- 차량번호(유효성) -->
		<if test="vhclNo != null and vhclNo != ''">
		AND		A.VHCL_NO = #{vhclNo}
		</if>
		<!-- 범칙금일련번호(유효성) -->
		<if test="fineSeq != null and fineSeq != ''">
		AND		A.FINE_SEQ = #{fineSeq}
		</if>
		ORDER BY ID
	</select>
	
	<!-- Update : 범칙금관리 확정 상태 업데이트 -->
	<update id="updateCfmtStat" parameterType="egovframework.penalty.FineMngeVO">
		<![CDATA[
		UPDATE	BIZ_FINE_MAS /*BIZ_범칙금기본*/
		SET		CFMT_DT = #{cfmtDt} /*확정일자*/
				, LAST_CHNGMN_ID = #{userId} /*최종변경자ID*/
				, LAST_CHGE_IP_ADDR = #{userIp} /*최종변경IP주소*/
		WHERE	VLT_DT = #{vltDt}
		AND		VLT_ATIME = #{vltAtime}
		AND		VHCL_NO = #{vhclNo}
		AND		FINE_SEQ = #{fineSeq}
		]]>
	</update>
	
	<!-- Retrieve : 범칙금관리 목록 조회 -->
	<select id="retrieveSendPlcDeptList" parameterType="egovframework.penalty.FineMngeVO" resultMap="ComnCdVO">
		<![CDATA[
		SELECT 	'SEND_PLC_DEPT_CD' AS COMN_CD_ENG_NM /*공통코드영문명(발송처부서코드)*/
				, A.SEND_PLC_SEQ AS CD_VAL /*발송처일련번호*/
				, A.NTCDOC_SEND_PLC_DEPT_NM AS CD_NM /*고지서발송처부서명*/
		FROM 	BIZ_FINE_SEND_PLC_STD_MNGE A /*BIZ_범칙금발송처기준관리*/
		WHERE 	A.SEND_PLC_CD = #{sendPlcCd}
		ORDER BY CD_VAL
		]]>
	</select>

	<!-- Update : 범칙금관리 수정 -->
	<update id="updateFine" parameterType="egovframework.penalty.FineMngeVO">
		<![CDATA[
		UPDATE	BIZ_FINE_MAS /*BIZ_범칙금기본*/
		SET		SEND_PLC_CD = #{sendPlcCd} /*발송처코드*/
				, SEND_PLC_SEQ = #{sendPlcSeq} /*발송처일련번호*/
				, VLT_KIND_CD = #{vltKindCd} /*위반종류코드*/
				, FINE_AMT = #{fineAmt} /*범칙금금액*/
				, VLT_CTS = #{vltCts} /*위반내용*/
				, VLT_PNT = #{vltPnt} /*위반장소*/
				, RCPT_DT = #{rcptDt} /*접수일자*/
				, PYMT_DDAY_DT = #{pymtDdayDt} /*납부기한일자*/
				, LAST_CHNGMN_ID = #{userId} /*최종변경자ID*/
				, LAST_CHGE_IP_ADDR = #{userIp} /*최종변경IP주소*/
		WHERE	VLT_DT = #{vltDt}
		AND		VLT_ATIME = #{vltAtime}
		AND		VHCL_NO = #{vhclNo}
		AND		FINE_SEQ = #{fineSeq}
		]]>
	</update>
	
	<!-- Delete : 범칙금관리 확정 상태 업데이트 -->
	<delete id="deleteFine" parameterType="egovframework.penalty.FineMngeVO">
		<![CDATA[
		DELETE
		FROM 	BIZ_FINE_MAS /*BIZ_범칙금기본*/
		WHERE	VLT_DT = #{vltDt}
		AND		VLT_ATIME = #{vltAtime}
		AND		VHCL_NO = #{vhclNo}
		AND		FINE_SEQ = #{fineSeq}
		]]>
	</delete>

	<!-- Retrieve : 차량번호로 대출정보 조회 -->
	<select id="retrieveVhclNoLoanMas" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	A.LOAN_NO /*대출번호*/
				, A.LOAN_SEQ /*대출일련번호*/
		FROM 	BIZ_LOAN_MAS A /*BIZ_대출기본*/
		WHERE 	A.VHCL_NO = #{vhcl_no}
		AND		#{vlt_dt} BETWEEN A.LOAN_DT AND A.TMNT_DT /*대출 기간에 위반한 대출건*/ 
		AND		(A.GD_CD LIKE 'AT%' OR A.GD_CD LIKE 'RC%') /*리스, 렌터카*/
		AND		A.LOAN_STAT_CD NOT IN ('4101', '4102') /*대출취소, 중도해약 제외 (저 코드값은 임시로 지정한것임)*/
		ORDER BY A.LOAN_NO DESC, A.LOAN_SEQ DESC
		LIMIT 1 /*조건에 만족하는 대출 중 최신 1건 조회*/
		]]>
	</select>
	
	<!-- Retrieve : 위반종류코드 조회 -->
	<select id="retrieveVltKindCd" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	CD_VAL AS VLT_KIND_CD /*위반종류코드*/
		FROM 	BIZ_COMN_CD_DTL /*BIZ_공통코드상세*/
		WHERE 	COMN_CD_ENG_NM = 'VLT_KIND_CD'
		AND		CD_NM LIKE '%'||#{vltKindCdKey1}||'%'
		AND		(
		]]>
		<if test="vltKindCdKey2 != null and vltKindCdKey2 != ''">
		AND		CD_NM LIKE '%'||#{vltKindCdKey2}||'%'
		</if>
		LIMIT 1
	</select>
</mapper>