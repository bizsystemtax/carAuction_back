<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="FineMngeDAO">
	<resultMap id="ComnCdVO" type="egovframework.penalty.ComnCdVO">
		<result property="comnCdEngNm" column="COMN_CD_ENG_NM"/>
		<result property="cdNm" column="CD_NM"/>
		<result property="cdVal" column="CD_VAL"/>
	</resultMap>
	
	<resultMap id="FineMngeVO" type="egovframework.penalty.FineMngeVO">
		<result property="inVltDtStrt" column="IN_VLT_DT_STRT"/>
		<result property="inVltDtEnd" column="IN_VLT_DT_END"/>
		<result property="inVltKindCd" column="IN_VLT_KIND_CD"/>
		<result property="inSendPlcCd" column="IN_SEND_PLC_CD"/>
		<result property="inFineUploadCd" column="IN_FINE_UPLOAD_CD"/>
		<result property="inCfmtYn" column="IN_CFMT_YN"/>
		<result property="inGdCd" column="IN_GD_CD"/>
		<result property="inCsNm" column="IN_CS_NM"/>
		<result property="inVhclNo" column="IN_VHCL_NO"/>
		<result property="id" column="ID"/>
		<result property="gdNm" column="GD_NM"/>
		<result property="csNm" column="CS_NM"/>
		<result property="vhclNo" column="VHCL_NO"/>
		<result property="vltDt" column="VLT_DT"/>
		<result property="vltAtime" column="VLT_ATIME"/>
		<result property="fineSeq" column="FINE_SEQ"/>
		<result property="fineUploadNm" column="FINE_UPLOAD_NM"/>
		<result property="cfmtStatNm" column="CFMT_STAT_NM"/>
		<result property="cfmtDt" column="CFMT_DT"/>
		<result property="sendPlcNm" column="SEND_PLC_NM"/>
		<result property="sendPlcSeq" column="SEND_PLC_SEQ"/>
		<result property="sendPlcDeptNm" column="SEND_PLC_DEPT_NM"/>
		<result property="vltKindCd" column="VLT_KIND_CD"/>
		<result property="vltKindNm" column="VLT_KIND_NM"/>
		<result property="vltCts" column="VLT_CTS"/>
		<result property="vltPnt" column="VLT_PNT"/>
		<result property="fineAmt" column="FINE_AMT"/>
		<result property="pymtDdayDt" column="PYMT_DDAY_DT"/>
		<result property="rcptDt" column="RCPT_DT"/>
		<result property="pymtDt" column="PYMT_DT"/>
		<result property="drvrChgeYn" column="DRVR_CHGE_YN"/>
		<result property="drvrChgeDt" column="DRVR_CHGE_DT"/>
		<result property="loanStatNm" column="LOAN_STAT_NM"/>
		<result property="loanNo" column="LOAN_NO"/>
		<result property="loanSeq" column="LOAN_SEQ"/>
		<result property="vltKindCdKey1" column="VLT_KIND_CD_KEY1"/>
		<result property="vltKindCdKey2" column="VLT_KIND_CD_KEY2"/>
		<result property="sendPlcCdKey" column="SEND_PLC_CD_KEY"/>
		
		<result property="csAddr" column="CS_ADDR"/>
		<result property="csAddrDtl" column="CS_ADDR_DTL"/>
		<result property="rnmNo" column="RNM_NO"/>
		<result property="rnmNo2" column="RNM_NO2"/>
		<result property="csBrno" column="CS_BRNO"/>
		<result property="drvLicNo" column="DRV_LIC_NO"/>
		<result property="vltTs" column="VLT_TS"/>
		<result property="authDt" column="AUTH_DT"/>
		<result property="telNo" column="TEL_NO"/>
		<result property="loanTrm" column="LOAN_TRM"/>
		<result property="vhclMdl" column="VHCL_MDL"/>
		<result property="rem" column="REM"/>
		<result property="bizNm" column="BIZ_NM"/>
		<result property="bizBrno" column="BIZ_BRNO"/>
		<result property="bizCrno" column="BIZ_CRNO"/>
		<result property="bizAddr" column="BIZ_ADDR"/>
		<result property="bizOfic" column="BIZ_OFIC"/>
		
		<result property="sessionId" column="SESSION_ID"/>
		<result property="sessionIp" column="SESSION_IP"/>
	</resultMap>
	
	<!-- Retrieve : 범칙금관리 검색조건 콤보박스 조회 -->
	<select id="retrieveComboBoxList" resultMap="ComnCdVO">
		<![CDATA[
		/*위반종류 코드명 오름차순 정렬 (20240829 박낙구 상무님 요청)*/
		SELECT 	COMN_CD_ENG_NM
				,CD_VAL
				,CD_NM
		FROM (SELECT	COMN_CD_ENG_NM /*공통코드영문명*/
						, CD_VAL /*코드값*/
						, CD_NM /*코드명*/
						,ROW_NUMBER() OVER (ORDER BY CD_NM) AS RANGE_COL
				FROM	BIZ_COMN_CD_DTL /*BIZ_공통코드상세*/
				WHERE	COMN_CD_ENG_NM = 'VLT_KIND_CD') AS VLT_KIND_CD
		UNION ALL
		SELECT	COMN_CD_ENG_NM /*공통코드영문명*/
				, CD_VAL /*코드값*/
				, CD_NM /*코드명*/
		FROM	BIZ_COMN_CD_DTL /*BIZ_공통코드상세*/
		WHERE	COMN_CD_ENG_NM = 'FINE_UPLOAD_CD'
		UNION ALL
		SELECT	'SEND_PLC_CD' AS COMN_CD_ENG_NM /*공통코드영문명(발송처코드)*/
				, A.SEND_PLC_CD AS CD_VAL /*발송처코드*/
				, A.NTCDOC_SEND_PLC_NM AS CD_NM /*고지서발송처명*/
		FROM	BIZ_FINE_SEND_PLC_STD_MNGE A /*BIZ_범칙금발송처기준관리*/
		WHERE 	A.SEND_PLC_SEQ = (SELECT MIN(SEND_PLC_SEQ)
								  FROM BIZ_FINE_SEND_PLC_STD_MNGE X 
								  WHERE A.SEND_PLC_CD = X.SEND_PLC_CD)
		]]>
	</select>
	
	<!-- Retrieve : 범칙금관리 목록 조회 -->
	<select id="retrieveFineMnge" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	ROW_NUMBER() OVER (ORDER BY A.VLT_DT DESC, A.FINE_SEQ DESC) AS ID /*순번*/
				, CASE WHEN B.GD_CD LIKE 'RC%' THEN '렌터카' ELSE '리스' END AS GD_NM /*상품명*/
				, B.CS_NM /*고객명*/
				, A.VHCL_NO /*차량번호*/
				, A.VLT_DT /*위반일자*/
				, A.VLT_ATIME /*위반시각*/
				, A.FINE_SEQ /*범칙금일련번호*/
				, (SELECT X.CD_NM FROM BIZ_COMN_CD_DTL X WHERE X.COMN_CD_ENG_NM = 'FINE_UPLOAD_CD' AND X.CD_VAL = A.FINE_UPLOAD_CD) AS FINE_UPLOAD_NM /*범칙금업로드명*/
				, A.FINE_UPLOAD_CD /*범칙금업로드코드*/
				, CASE WHEN A.CFMT_DT != '' THEN '확정' ELSE '미확정' END AS CFMT_STAT_NM /*확정상태명*/
				, A.CFMT_DT /*확정일자*/
				, C.SEND_PLC_CD AS SEND_PLC_CD /*발송처코드*/
				, C.NTCDOC_SEND_PLC_NM AS SEND_PLC_NM /*발송처명*/
				, C.SEND_PLC_SEQ AS SEND_PLC_SEQ /*발송처일련번호*/
				, C.NTCDOC_SEND_PLC_DEPT_NM AS SEND_PLC_DEPT_NM /*발송처부서명*/
				, A.VLT_KIND_CD AS VLT_KIND_CD /*위반종류코드*/
				, (SELECT X.CD_NM FROM BIZ_COMN_CD_DTL X WHERE X.COMN_CD_ENG_NM = 'VLT_KIND_CD' AND X.CD_VAL = A.VLT_KIND_CD) AS VLT_KIND_NM /*위반종류명*/
				, A.VLT_CTS  /*위반내용*/
				, A.VLT_PNT  /*위반장소*/
				, A.FINE_AMT /*범칙금금액*/
				, A.PYMT_DDAY_DT /*납부기한일자*/
				, A.RCPT_DT /*접수일자*/
				, A.PYMT_DT /*납입일자*/
				, CASE WHEN A.DRVR_CHGE_DT != '' THEN 'Y' ELSE 'N' END AS DRVR_CHGE_YN /*운전자변경여부*/
				, A.DRVR_CHGE_DT /*운전자변경일*/
				, (SELECT X.CD_NM FROM BIZ_COMN_CD_DTL X WHERE X.COMN_CD_ENG_NM = 'LOAN_STAT_CD' AND X.CD_VAL = B.LOAN_STAT_CD) AS LOAN_STAT_NM /*대출상태명*/
		FROM 	BIZ_FINE_MAS A 
				, BIZ_LOAN_MAS B 
				, BIZ_FINE_SEND_PLC_STD_MNGE C 
		WHERE 	A.VHCL_NO = B.VHCL_NO 
		AND 	A.VLT_DT >= B.LOAN_DT
		AND 	(A.VLT_DT < B.TMNT_DT OR B.TMNT_DT = '')
		AND 	A.SEND_PLC_CD = C.SEND_PLC_CD 
		AND 	A.SEND_PLC_SEQ = C.SEND_PLC_SEQ
		AND		A.VLT_DT BETWEEN #{inVltDtStrt} AND #{inVltDtEnd} /*검색조건-위반일자*/
		]]>
		<!-- 위반종류코드 -->
		<if test="inVltKindCd != null and inVltKindCd != ''">
		AND		A.VLT_KIND_CD = #{inVltKindCd}
		</if>
		<!-- 발송처코드 -->
		<if test="inSendPlcCd != null and inSendPlcCd != ''">
		AND		A.SEND_PLC_CD = #{inSendPlcCd}
		</if>
		<!-- 업로드구분 -->
		<if test="inFineUploadCd != null and inFineUploadCd != ''">
		AND		A.FINE_UPLOAD_CD = #{inFineUploadCd}
		</if>
		<!-- 확정여부(X) -->
		<if test="inCfmtYn == 99">
		AND		A.CFMT_DT = NULL
		</if>
		<!-- 확정여부(확정) -->
		<if test="inCfmtYn == 1">
		AND		A.CFMT_DT != ''
		</if>
		<!-- 확정여부(미확정) -->
		<if test="inCfmtYn == 2">
		AND		A.CFMT_DT = ''
		</if>
		<!-- 상품코드(X) -->
		<if test="inGdCd == 99">
		AND		B.GD_CD = NULL
		</if>
		<!-- 상품코드(리스) -->
		<if test="inGdCd == 1">
		AND		B.GD_CD NOT LIKE 'RC%'
		</if>
		<!-- 상품코드(렌터카) -->
		<if test="inGdCd == 2">
		AND		B.GD_CD LIKE 'RC%'
		</if>
		<!-- 고객명 -->
		<if test="inCsNm != null and inCsNm != ''">
		AND		B.CS_NM LIKE CONCAT('%', #{inCsNm}, '%')
		</if>
		<!-- 차량번호 -->
		<if test="inVhclNo != null and inVhclNo != ''">
		AND		A.VHCL_NO LIKE CONCAT('%', #{inVhclNo}, '%')
		</if>
		<!-- 위반시각(유효성) -->
		<if test="vltAtime != null and vltAtime != ''">
		AND		A.VLT_ATIME = #{vltAtime}
		</if>
		<!-- 차량번호(유효성) -->
		<if test="vhclNo != null and vhclNo != ''">
		AND		A.VHCL_NO = #{vhclNo}
		</if>
		<!-- 범칙금일련번호(유효성) -->
		<if test="fineSeq != null and fineSeq != ''">
		AND		A.FINE_SEQ = #{fineSeq}
		</if>
		ORDER BY ID
	</select>

	<!-- Retrieve : 범칙금관리 중복 조회 -->
	<select id="retrieveFineDupeCheck" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	A.VHCL_NO /*차량번호*/
				, A.VLT_DT /*위반일자*/
				, A.VLT_ATIME /*위반시각*/
				, A.FINE_SEQ /*범칙금일련번호*/
		FROM 	BIZ_FINE_MAS A 
		WHERE 	A.VLT_DT = #{vltDt} /*위반일자*/
		AND		A.VLT_ATIME = #{vltAtime} /*위반시각*/
		AND		A.VHCL_NO = #{vhclNo} /*차량번호*/
		]]>
	</select>
	
	<!-- Update : 범칙금관리 확정 상태 업데이트 -->
	<update id="updateCfmtStat" parameterType="egovframework.penalty.FineMngeVO">
		<![CDATA[
		UPDATE	BIZ_FINE_MAS /*BIZ_범칙금기본*/
		SET		CFMT_DT = #{cfmtDt} /*확정일자*/
				, LAST_CHNGMN_ID = #{sessionId} /*최종변경자ID*/
				, LAST_CHGE_IP_ADDR = #{sessionIp} /*최종변경IP주소*/
		WHERE	VLT_DT = #{vltDt}
		AND		VLT_ATIME = #{vltAtime}
		AND		VHCL_NO = #{vhclNo}
		AND		FINE_SEQ = #{fineSeq}
		]]>
	</update>
	
	<!-- Retrieve : 범칙금관리 목록 조회 -->
	<select id="retrieveSendPlcDeptList" parameterType="egovframework.penalty.FineMngeVO" resultMap="ComnCdVO">
		<![CDATA[
		SELECT 	'SEND_PLC_DEPT_CD' AS COMN_CD_ENG_NM /*공통코드영문명(발송처부서코드)*/
				, A.SEND_PLC_SEQ AS CD_VAL /*발송처일련번호*/
				, A.NTCDOC_SEND_PLC_DEPT_NM AS CD_NM /*고지서발송처부서명*/
		FROM 	BIZ_FINE_SEND_PLC_STD_MNGE A /*BIZ_범칙금발송처기준관리*/
		WHERE 	A.SEND_PLC_CD = #{sendPlcCd}
		ORDER BY CD_VAL
		]]>
	</select>

	<!-- Update : 범칙금관리 등록 -->
	<insert id="insertFine" parameterType="egovframework.penalty.FineMngeVO">
		<![CDATA[
		INSERT INTO BIZ_FINE_MAS /*BIZ_범칙금기본*/
		(	
			VLT_DT /*위반일자*/
			,VLT_ATIME /*위반시각*/
			,VHCL_NO /*차량번호*/
			,FINE_SEQ /*범칙금일련번호*/
			,VLT_KIND_CD /*위반종류코드*/
			,SEND_PLC_CD /*발송처코드*/
			,SEND_PLC_SEQ /*발송처일련번호*/
			,VLT_CTS /*위반내용*/
			,VLT_PNT /*위반장소*/
			,RCPT_DT /*접수일자*/
			,PYMT_DDAY_DT /*납부기한일자*/
			,FINE_AMT /*범칙금금액*/
			,NTCDOC_KIND_CD /*고지서종류코드*/
			,ACT_BANK_NM1 /*계좌은행명1*/
			,ACT_NO1 /*계좌번호1*/
			,ACT_BANK_NM2 /*계좌은행명2*/
			,ACT_NO2 /*계좌번호2*/
			,ACT_BANK_NM3 /*계좌은행명3*/
			,ACT_NO3 /*계좌번호3*/
			,ACT_BANK_NM4 /*계좌은행명4*/
			,ACT_NO4 /*계좌번호4*/
			,FINE_UPLOAD_CD /*범칙금업로드코드*/
			,DOC_FINE_NO1 /*문서범칙금번호1*/
			,DOC_FINE_NO2 /*문서범칙금번호2*/
			,DOC_FINE_NO3 /*문서범칙금번호3*/
			,DOC_FINE_NO4 /*문서범칙금번호4*/
			,PNLT_STAT_NM /*과태료상태명*/
			,FIRST_REGR_ID /*최초등록자ID*/
			,FIRST_REG_IP_ADDR /*최초등록IP주소*/
			,LAST_CHNGMN_ID /*최종변경자ID*/
			,LAST_CHGE_IP_ADDR /*최종변경IP주소*/
		)
		VALUE
		(
			CAST(#{vltDt} AS VARCHAR(8))
			,CAST(#{vltAtime} AS VARCHAR(6))
			,CAST(#{vhclNo} AS VARCHAR(20))
			,CAST(#{fineSeq} AS DECIMAL(11,0))
			,CAST(IFNULL(#{vltKindCd}, '') AS VARCHAR(2))
			,CAST(IFNULL(#{sendPlcCd}, '') AS VARCHAR(3))
			,CAST(IFNULL(#{sendPlcSeq}, 0) AS DECIMAL(4,0))
			,CAST(IFNULL(#{vltCts}, '') AS VARCHAR(500))
			,CAST(IFNULL(#{vltPnt}, '') AS VARCHAR(500))
			,CAST(IFNULL(#{rcptDt}, '') AS VARCHAR(8))
			,CAST(IFNULL(#{pymtDdayDt}, '') AS VARCHAR(8))
			,CAST(IFNULL(#{fineAmt}, 0) AS DECIMAL(15,0))
			,CAST(IFNULL(#{ntcdocKindCd}, '') AS VARCHAR(1))
			,CAST(IFNULL(#{actBankNm1}, '') AS VARCHAR(20))
			,CAST(IFNULL(#{actNo1}, '') AS VARCHAR(20))
			,CAST(IFNULL(#{actBankNm2}, '') AS VARCHAR(20))
			,CAST(IFNULL(#{actNo2}, '') AS VARCHAR(20))
			,CAST(IFNULL(#{actBankNm3}, '') AS VARCHAR(20))
			,CAST(IFNULL(#{actNo3}, '') AS VARCHAR(20))
			,CAST(IFNULL(#{actBankNm4}, '') AS VARCHAR(20))
			,CAST(IFNULL(#{actNo4}, '') AS VARCHAR(20))
			,CAST(IFNULL(#{fineUploadCd}, '') AS VARCHAR(1))
			,CAST(IFNULL(#{docFineNo1}, '') AS VARCHAR(50))
			,CAST(IFNULL(#{docFineNo2}, '') AS VARCHAR(50))
			,CAST(IFNULL(#{docFineNo3}, '') AS VARCHAR(50))
			,CAST(IFNULL(#{docFineNo4}, '') AS VARCHAR(50))
			,CAST(IFNULL(#{pnltStatNm}, '') AS VARCHAR(10))
			,CAST(#{sessionId} AS VARCHAR(18))
			,CAST(#{sessionIp} AS VARCHAR(18))
			,CAST(#{sessionId} AS VARCHAR(18))
			,CAST(#{sessionIp} AS VARCHAR(18))
		)
		]]>
	</insert>

	<!-- Update : 범칙금관리 수정 -->
	<update id="updateFine" parameterType="egovframework.penalty.FineMngeVO">
		<![CDATA[
		UPDATE	BIZ_FINE_MAS /*BIZ_범칙금기본*/
		SET		SEND_PLC_CD = #{sendPlcCd} /*발송처코드*/
				, SEND_PLC_SEQ = #{sendPlcSeq} /*발송처일련번호*/
				, VLT_KIND_CD = #{vltKindCd} /*위반종류코드*/
				, FINE_AMT = #{fineAmt} /*범칙금금액*/
				, VLT_CTS = #{vltCts} /*위반내용*/
				, VLT_PNT = #{vltPnt} /*위반장소*/
				, RCPT_DT = #{rcptDt} /*접수일자*/
				, PYMT_DDAY_DT = #{pymtDdayDt} /*납부기한일자*/
				, LAST_CHNGMN_ID = #{sessionId} /*최종변경자ID*/
				, LAST_CHGE_IP_ADDR = #{sessionIp} /*최종변경IP주소*/
		WHERE	VLT_DT = #{vltDt}
		AND		VLT_ATIME = #{vltAtime}
		AND		VHCL_NO = #{vhclNo}
		AND		FINE_SEQ = #{fineSeq}
		]]>
	</update>
	
	<!-- Delete : 범칙금관리 삭제 -->
	<delete id="deleteFine" parameterType="egovframework.penalty.FineMngeVO">
		<![CDATA[
		DELETE
		FROM 	BIZ_FINE_MAS /*BIZ_범칙금기본*/
		WHERE	VLT_DT = #{vltDt}
		AND		VLT_ATIME = #{vltAtime}
		AND		VHCL_NO = #{vhclNo}
		AND		FINE_SEQ = #{fineSeq}
		]]>
	</delete>

	<!-- Retrieve : 차량번호로 대출정보 조회 -->
	<select id="retrieveVhclNoLoanMas" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	A.LOAN_NO /*대출번호*/
				, A.LOAN_SEQ /*대출일련번호*/
		FROM 	BIZ_LOAN_MAS A /*BIZ_대출기본*/
		WHERE 	A.VHCL_NO = #{vhclNo}
		AND		((A.TMNT_DT != '' AND #{vltDt} BETWEEN A.LOAN_DT AND A.TMNT_DT)
				OR A.TMNT_DT = '' AND #{vltDt} >= A.LOAN_DT) /*대출 기간 중에 위반한 대출건*/ 
		AND		(A.GD_CD LIKE 'AT%' OR A.GD_CD LIKE 'RC%') /*리스, 렌터카*/
		AND		A.LOAN_STAT_CD NOT IN ('4101', '4102') /*대출취소, 중도해약 제외 (저 코드값은 임시로 지정한것임)*/
		ORDER BY A.LOAN_NO DESC, A.LOAN_SEQ DESC
		LIMIT 1 /*조건에 만족하는 대출 중 최신 1건 조회*/
		]]>
	</select>

	<!-- Retrieve : 범칙금일련번호 채번 -->
	<select id="retrieveFineSeqSN" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT MAX(FINE_SEQ)+1 AS FINE_SEQ /*동일 위반일자의 MAX+1*/
		FROM BIZ_FINE_MAS /*BIZ_범칙금기본*/
		WHERE VLT_DT = #{vltDt}
		]]>
	</select>
	
	<!-- Retrieve : 위반종류코드 조회 -->
	<select id="retrieveVltKindCd" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	CD_VAL AS VLT_KIND_CD /*위반종류코드*/
		FROM 	BIZ_COMN_CD_DTL /*BIZ_공통코드상세*/
		WHERE 	COMN_CD_ENG_NM = 'VLT_KIND_CD'
		AND		CD_NM LIKE CONCAT('%', #{vltKindCdKey1}, '%')
		]]>
		<if test="vltKindCdKey2 != null and vltKindCdKey2 != ''">
		AND		CD_NM LIKE CONCAT('%', #{vltKindCdKey2}, '%')
		</if>
		LIMIT 1
	</select>

	<!-- Retrieve : 발송처코드 조회 -->
	<select id="retrieveSendPlcCd" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		WITH SENDPLC AS ( /*조건에 부합하는 발송처 코드값 및 키워드 YN 값 찾기*/
			SELECT	CASE 	WHEN A.ST1_DEPT_KEY_WORD_CTS = '' THEN 0
						 	WHEN #{vltCts} LIKE CONCAT('%', A.ST1_DEPT_KEY_WORD_CTS, '%') THEN 1 ELSE 0 END AS ST1_YN
					,CASE	WHEN A.SCND_DEPT_KEY_WORD_CTS = '' THEN 0
							WHEN #{vltCts} LIKE CONCAT('%', A.SCND_DEPT_KEY_WORD_CTS, '%') THEN 1 ELSE 0 END AS SCND_YN
					,CASE	WHEN A.THRD_DEPT_KEY_WORD_CTS = '' THEN 0
							WHEN #{vltPnt} LIKE CONCAT('%', A.THRD_DEPT_KEY_WORD_CTS, '%') THEN 1 ELSE 0 END AS THRD_YN
					,CASE	WHEN A.THRD_DEPT_KEY_WORD_CTS = '' THEN 0
							WHEN #{vltCts} LIKE CONCAT('%', A.THRD_DEPT_KEY_WORD_CTS, '%') THEN 1 ELSE 0 END AS THRD2_YN
					,A.SEND_PLC_CD
			FROM	BIZ_FINE_SEND_PLC_STD_MNGE A /*BIZ_범칙금발송처기준관리*/
					,(	SELECT CASE WHEN COUNT(SEND_PLC_CD) = 0
									THEN '233'
									ELSE SEND_PLC_CD
							   END AS SEND_PLC_CD
						FROM BIZ_FINE_SEND_PLC_STD_MNGE /*BIZ_범칙금발송처기준관리*/
						WHERE CASE WHEN (CASE WHEN (SELECT 	COUNT(DISTINCT SEND_PLC_CD)
													FROM	BIZ_FINE_SEND_PLC_STD_MNGE
													WHERE	REPLACE(COMN_SEND_PLC_NM, ' ', '') LIKE CONCAT('%', #{sendPlcCdKey}, '%')) = 0
											  THEN SEND_PLC_CD = '233'
										END)
								   THEN 1
								   WHEN (CASE WHEN (SELECT	COUNT(DISTINCT SEND_PLC_CD)
								   					FROM	BIZ_FINE_SEND_PLC_STD_MNGE
													WHERE	REPLACE(COMN_SEND_PLC_NM, ' ', '') LIKE CONCAT('%', #{sendPlcCdKey})) = 1
											  THEN	REPLACE(COMN_SEND_PLC_NM, ' ', '') LIKE CONCAT('%', #{sendPlcCdKey})
											  WHEN	(SELECT	COUNT(DISTINCT SEND_PLC_CD)
								   					FROM	BIZ_FINE_SEND_PLC_STD_MNGE
													WHERE	REPLACE(COMN_SEND_PLC_NM, ' ', '') = #{sendPlcCdKey}) > 0
											  THEN	REPLACE(COMN_SEND_PLC_NM, ' ', '') = #{sendPlcCdKey}
											  WHEN	(SELECT	COUNT(DISTINCT SEND_PLC_CD)
								   					FROM	BIZ_FINE_SEND_PLC_STD_MNGE
													WHERE	REPLACE(COMN_SEND_PLC_NM, ' ', '') LIKE CONCAT('%', #{sendPlcCdKey}, '%')) > 0
											  THEN	REPLACE(COMN_SEND_PLC_NM, ' ', '') LIKE CONCAT('%', #{sendPlcCdKey}, '%')
										END)
								   THEN 1
								   ELSE 0
							  END = 1
					) B
			WHERE	CASE WHEN (CASE WHEN B.SEND_PLC_CD = '233'
									THEN (CASE WHEN (SELECT COUNT(DISTINCT SEND_PLC_CD)
													 FROM	BIZ_FINE_SEND_PLC_STD_MNGE
													 WHERE	REPLACE(NTCDOC_SEND_PLC_NM, ' ', '') LIKE CONCAT('%', #{sendPlcCdKey}, '%')) > 0
											   THEN	REPLACE(A.NTCDOC_SEND_PLC_NM, ' ', '') LIKE CONCAT('%', #{sendPlcCdKey}, '%')
											   ELSE A.SEND_PLC_CD = B.SEND_PLC_CD
										 END)
									ELSE A.SEND_PLC_CD = B.SEND_PLC_CD
							  END)
						 THEN 1
						 ELSE 0
					END = 1
			ORDER BY A.SEND_PLC_CD ASC, A.SEND_PLC_SEQ ASC
		),
		
		SEARCH_KEY_CODE AS ( /*SENDPLC에서 얻은 값으로 경우의 수에 따른 키코드 찾기*/
			SELECT CASE WHEN A.ST1_SUM = 0 /*키워드1 걸린게 없을 때*/
						THEN (CASE 	WHEN A.SCND_SUM = 0 /*키워드2 걸린게 없을 때*/
									THEN (CASE WHEN A.THRD_SUM = 0 /*키워드3 걸린게 없을 때*/
											   THEN (CASE 	WHEN A.THRD2_SUM = 0 /*키워드3-2 걸린게 없을 때*/
															THEN '000'
															WHEN A.THRD2_SUM >= 1 /*키워드3-2 걸린게 1개보다 크거나 같을 때*/
															THEN '002'
													 END)
									
									
											   WHEN A.THRD_SUM >= 1 /*키워드3 걸린게 1개보다 크거나 같을 때*/
											   THEN '001'
							 			 END)
									WHEN A.SCND_SUM = 1 /*키워드2 걸린게 1개일 때*/
									THEN '010'
									WHEN A.SCND_SUM > 1 /*키워드2 걸린게 1개보다 클 때*/
									THEN (CASE WHEN A.SCND_THRD_SUM = 0 /*키워드2&키워드3 걸린게 없을 때*/
											   THEN (CASE WHEN A.SCND_THRD2_SUM = 0 /*키워드2&키워드3-2 걸린게 없을 때*/
											   			  THEN '010'
											   			  WHEN A.SCND_THRD2_SUM >= 1 /*키워드2&키워드3-2 걸린게 1개보다 크거나 같을 때*/
											   			  THEN '012'
											   		END)
											   WHEN A.SCND_THRD_SUM >= 1 /*키워드2&키워드3 걸린게 1개보다 크거나 같을 때*/
											   THEN '011'
										 END)
							 END)
						WHEN A.ST1_SUM = 1 /*키워드1 걸린게 1개일 때*/
						THEN '100'
						WHEN A.ST1_SUM > 1 /*키워드1 걸린게 1개보다 클 때*/
						THEN (CASE WHEN A.ST1_SCND_SUM = 0 /*키워드1&키워드2 걸린게 없을 때*/
								   THEN (CASE WHEN A.ST1_THRD_SUM = 0 /*키워드1&키워드3 걸린게 없을 때*/
								   			  THEN (CASE WHEN A.ST1_THRD2_SUM = 0 /*키워드1&키워드3-2 걸린게 없을 때*/
								   			  			 THEN '100'
								   			  			 WHEN A.ST1_THRD2_SUM >= 1 /*키워드1&키워드3-2 걸린게 1개보다 크거나 같을 때*/
								   			  			 THEN '102'
								   			  	   END)
								   			  WHEN A.ST1_THRD_SUM >= 1 /*키워드1&키워드3 걸린게 1개보다 크거나 같을 때*/
								   			  THEN '101'
								   		END)
								   WHEN A.ST1_SCND_SUM = 1 /*키워드1&키워드2 걸린게 1개일 때*/
								   THEN '110'
								   WHEN A.ST1_SCND_SUM > 1 /*키워드1&키워드2 걸린게 1개보다 클 때*/
								   THEN (CASE WHEN A.ST1_SCND_THRD_SUM = 0 /*키워드1&키워드2&키워드3 걸린게 없을 때*/
								   			  THEN (CASE WHEN A.ST1_SCND_THRD2_SUM = 0 /*키워드1&키워드2&키워드3-2 걸린게 없을 때*/
								   			  			 THEN '110'
											   			 WHEN A.ST1_SCND_THRD2_SUM >= 1 /*키워드1&키워드2&키워드3-2 걸린게 1개보다 크거나 같을 때*/
											   			 THEN '112'
											   	   END)
											  WHEN A.ST1_SCND_THRD_SUM >= 1 /*키워드1&키워드2&키워드3 걸린게 1개보다 크거나 같을 때*/
											  THEN '111'
										END)
							 END)
				   END AS KEYCODE
				   ,A.ST1_SUM
				   ,A.SCND_SUM
				   ,A.THRD_SUM
				   ,A.THRD2_SUM
				   ,A.ST1_SCND_SUM
				   ,A.ST1_SCND_THRD_SUM
				   ,A.ST1_THRD_SUM
				   ,A.SCND_THRD_SUM
				   ,A.ST1_SCND_THRD2_SUM
				   ,A.ST1_THRD2_SUM
				   ,A.SCND_THRD2_SUM
			FROM	(SELECT SUM(ST1_YN) AS ST1_SUM
							,SUM(SCND_YN) AS SCND_SUM
							,SUM(THRD_YN) AS THRD_SUM
							,SUM(THRD2_YN) AS THRD2_SUM
							,SUM(CASE WHEN ST1_YN=1 AND SCND_YN=1 THEN 1 ELSE 0 END) AS ST1_SCND_SUM
							,SUM(CASE WHEN ST1_YN=1 AND SCND_YN=1 AND THRD_YN=1 THEN 1 ELSE 0 END) AS ST1_SCND_THRD_SUM
							,SUM(CASE WHEN ST1_YN=1 AND THRD_YN=1 THEN 1 ELSE 0 END) AS ST1_THRD_SUM
							,SUM(CASE WHEN SCND_YN=1 AND THRD_YN=1 THEN 1 ELSE 0 END) AS SCND_THRD_SUM
							,SUM(CASE WHEN ST1_YN=1 AND SCND_YN=1 AND THRD2_YN=1 THEN 1 ELSE 0 END) AS ST1_SCND_THRD2_SUM
							,SUM(CASE WHEN ST1_YN=1 AND THRD2_YN=1 THEN 1 ELSE 0 END) AS ST1_THRD2_SUM
							,SUM(CASE WHEN SCND_YN=1 AND THRD2_YN=1 THEN 1 ELSE 0 END) AS SCND_THRD2_SUM
					FROM SENDPLC) A
		)
		
		SELECT	A.SEND_PLC_CD /*발송처코드*/
				,A.SEND_PLC_SEQ /*발송처일련번호*/
				,A.NTCDOC_SEND_PLC_NM AS SEND_PLC_NM /*고지서발송처명*/
		FROM	BIZ_FINE_SEND_PLC_STD_MNGE A /*BIZ_범칙금발송처기준관리*/
				,SEARCH_KEY_CODE K
				,SENDPLC L
		WHERE	A.SEND_PLC_CD = L.SEND_PLC_CD
		AND		(K.KEYCODE = '000'
				OR	(K.KEYCODE = '100'
					AND A.ST1_DEPT_KEY_WORD_CTS != ''
					AND #{vltCts} LIKE CONCAT('%', A.ST1_DEPT_KEY_WORD_CTS, '%'))
				OR	(K.KEYCODE = '010'
					AND A.SCND_DEPT_KEY_WORD_CTS != ''
					AND #{vltCts} LIKE CONCAT('%', A.SCND_DEPT_KEY_WORD_CTS, '%'))
				OR	(K.KEYCODE = '001'
					AND A.THRD_DEPT_KEY_WORD_CTS != ''
					AND #{vltPnt} LIKE CONCAT('%', A.THRD_DEPT_KEY_WORD_CTS, '%'))
				OR	(K.KEYCODE = '110'
					AND A.ST1_DEPT_KEY_WORD_CTS != '' AND A.SCND_DEPT_KEY_WORD_CTS != ''
					AND #{vltCts} LIKE CONCAT('%', A.ST1_DEPT_KEY_WORD_CTS, '%')
					AND #{vltCts} LIKE CONCAT('%', A.SCND_DEPT_KEY_WORD_CTS, '%'))
				OR	(K.KEYCODE = '101'
					AND A.ST1_DEPT_KEY_WORD_CTS != '' AND A.THRD_DEPT_KEY_WORD_CTS != ''
					AND #{vltCts} LIKE CONCAT('%', A.ST1_DEPT_KEY_WORD_CTS, '%')
					AND #{vltPnt} LIKE CONCAT('%', A.THRD_DEPT_KEY_WORD_CTS, '%'))
				OR	(K.KEYCODE = '011'
					AND A.SCND_DEPT_KEY_WORD_CTS != '' AND A.THRD_DEPT_KEY_WORD_CTS != ''
					AND #{vltCts} LIKE CONCAT('%', A.SCND_DEPT_KEY_WORD_CTS, '%')
					AND #{vltPnt} LIKE CONCAT('%', A.THRD_DEPT_KEY_WORD_CTS, '%'))
				OR	(K.KEYCODE = '111'
					AND A.ST1_DEPT_KEY_WORD_CTS != '' AND A.SCND_DEPT_KEY_WORD_CTS != '' AND A.THRD_DEPT_KEY_WORD_CTS != ''
					AND #{vltCts} LIKE CONCAT('%', A.ST1_DEPT_KEY_WORD_CTS, '%')
					AND #{vltCts} LIKE CONCAT('%', A.SCND_DEPT_KEY_WORD_CTS, '%')
					AND #{vltPnt} LIKE CONCAT('%', A.THRD_DEPT_KEY_WORD_CTS, '%'))
				OR	(K.KEYCODE = '002'
					AND A.THRD_DEPT_KEY_WORD_CTS != ''
					AND #{vltCts} LIKE CONCAT('%', A.THRD_DEPT_KEY_WORD_CTS, '%'))
				OR	(K.KEYCODE = '102'
					AND A.ST1_DEPT_KEY_WORD_CTS != '' AND A.THRD_DEPT_KEY_WORD_CTS != ''
					AND #{vltCts} LIKE CONCAT('%', A.ST1_DEPT_KEY_WORD_CTS, '%')
					AND #{vltCts} LIKE CONCAT('%', A.THRD_DEPT_KEY_WORD_CTS, '%'))
				OR	(K.KEYCODE = '012'
					AND A.SCND_DEPT_KEY_WORD_CTS != '' AND A.THRD_DEPT_KEY_WORD_CTS != ''
					AND #{vltCts} LIKE CONCAT('%', A.SCND_DEPT_KEY_WORD_CTS, '%')
					AND #{vltCts} LIKE CONCAT('%', A.THRD_DEPT_KEY_WORD_CTS, '%'))
				OR	(K.KEYCODE = '112'
					AND A.ST1_DEPT_KEY_WORD_CTS != '' AND A.SCND_DEPT_KEY_WORD_CTS != '' AND A.THRD_DEPT_KEY_WORD_CTS != ''
					AND #{vltCts} LIKE CONCAT('%', A.ST1_DEPT_KEY_WORD_CTS, '%')
					AND #{vltCts} LIKE CONCAT('%', A.SCND_DEPT_KEY_WORD_CTS, '%')
					AND #{vltCts} LIKE CONCAT('%', A.THRD_DEPT_KEY_WORD_CTS, '%')))
		ORDER BY A.SEND_PLC_CD ASC, A.SEND_PLC_SEQ ASC
		LIMIT 1
		]]>
	</select>
	
	<!-- Retrieve : 다운로드(이파인) 조회 -->
	<select id="retrieveDownloadEfine" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	A.DOC_FINE_NO1 AS col1 /*순번*/
				,A.DOC_FINE_NO2 AS col2 /*요청번호*/
				,A.DOC_FINE_NO3 AS col3 /*과태료번호*/
				,CONCAT(CONCAT(SUBSTRING(A.VLT_DT, 1, 4), '-', SUBSTRING(A.VLT_DT, 5, 2), '-', SUBSTRING(A.VLT_DT, 7, 2))
						, ' '
						, CONCAT(SUBSTRING(A.VLT_ATIME, 1, 2), ':', SUBSTRING(A.VLT_ATIME, 3, 2), ':', SUBSTRING(A.VLT_ATIME, 5, 2))
       			) AS col4 /*위반일시*/
       			,A.VLT_PNT AS col5 /*위반장소*/
       			,A.VLT_CTS AS col6 /*위반내용*/
       			,A.VHCL_NO AS col7 /*차량번호*/
       			,B.NTCDOC_SEND_PLC_NM AS col8 /*관할관서*/
       			,A.PNLT_STAT_NM AS col9 /*과태료상태*/
       			,A.FINE_AMT AS col10 /*과태료금액*/
       			,A.DOC_FINE_NO4 AS col11 /*일련번호*/
       			,CONCAT(A.ACT_BANK_NM1, ' ', A.ACT_NO1,
       					CASE WHEN A.ACT_BANK_NM2 != '' THEN CONCAT(' ', A.ACT_BANK_NM2, ' ', A.ACT_NO2) ELSE '' END,
       					CASE WHEN A.ACT_BANK_NM3 != '' THEN CONCAT(' ', A.ACT_BANK_NM3, ' ', A.ACT_NO3) ELSE '' END,
       					CASE WHEN A.ACT_BANK_NM4 != '' THEN CONCAT(' ', A.ACT_BANK_NM4, ' ', A.ACT_NO4) ELSE '' END) AS col12 /*가상계좌번호*/
       			,CASE WHEN A.PYMT_DDAY_DT != ''
       				  THEN CONCAT(SUBSTRING(A.PYMT_DDAY_DT , 1, 4),
		       				  	  '-',
		       				  	  SUBSTRING(A.PYMT_DDAY_DT , 5, 2), 
		       				  	  '-',
		       				  	  SUBSTRING(A.PYMT_DDAY_DT , 7, 2))
       				  ELSE ''
       			END AS col13 /*납부기한*/
       			,C.CS_NM AS col14 /*위반자성명*/
       			,CASE WHEN C.CS_TYP_CD IN ('1', '2', '5') THEN '0'
       				  WHEN C.CS_TYP_CD IN ('3', '4') THEN '2'
       				  ELSE ''
       			END AS col15 /*위반자구분*/
       			,CASE WHEN C.GD_CD LIKE 'RC%' AND C.CS_TYP_CD IN ('1', '2', '5') THEN ''
       				  ELSE CONCAT(SUBSTRING(C.RNM_NO , 1, 6),
		       				  	  '-', 
		       				  	  SUBSTRING(C.RNM_NO , 7, 7))
       			END AS col16 /*주민법인번호(렌터카 개인은 공란)*/
       			,CASE WHEN C.GD_CD LIKE 'RC%' AND C.CS_TYP_CD IN ('1', '2', '5') THEN ''
       				  ELSE CONCAT(SUBSTRING(C.DRV_LIC_NO , 1, 2),
       				  			  '-',
       				  			  SUBSTRING(C.DRV_LIC_NO , 3, 2),
       				  			  '-',
       				  			  SUBSTRING(C.DRV_LIC_NO , 5, 6),
       				  			  '-',
       				  			  SUBSTRING(C.DRV_LIC_NO , 11, 2))
       			END AS col17 /*면허번호(렌터카 개인은 공란)*/
       			,CONCAT(C.CS_ADDR, CASE WHEN C.CS_ADDR_DTL != '' THEN CONCAT(', ', C.CS_ADDR_DTL) ELSE '' END) AS col18 /*주소(필수)*/
       			,CONCAT(C.LOAN_NO, '-', C.LOAN_SEQ) AS col19 /*계약번호(필수)*/
       			/*계약일자(대출일자)의 경우엔 재렌트는 기대출의 대출일자를 가져와야 할 수 있으므로 업체별 기준 확인 필요*/
       			,CONCAT(SUBSTRING(C.LOAN_DT , 1, 4),
	   				  	'-',
	   				  	SUBSTRING(C.LOAN_DT , 5, 2), 
	   				  	'-',
	   				  	SUBSTRING(C.LOAN_DT , 7, 2)) AS col20 /*계약일자(필수)*/
	   			/*해지건은 해지일자 표시하고 나머지는 만기일자 표시하는지 업체별 확인 필요*/
	   			,CONCAT(SUBSTRING(C.MTRT_DT , 1, 4),
	   				  	'-',
	   				  	SUBSTRING(C.MTRT_DT , 5, 2), 
	   				  	'-',
	   				  	SUBSTRING(C.MTRT_DT , 7, 2)) AS col21 /*계약먄료일(필수)*/
	   			,A.VHCL_NO AS col22 /*계약차량번호*/
		FROM 	BIZ_FINE_MAS A /*BIZ_범칙금기본*/
				,BIZ_FINE_SEND_PLC_STD_MNGE B /*BIZ_범칙금관공서기준관리*/
				,BIZ_LOAN_MAS C /*BIZ_대출기본*/
		WHERE 	A.VLT_DT = #{vltDt} /*위반일자*/
		AND		A.VLT_ATIME = #{vltAtime} /*위반시각*/
		AND		A.VHCL_NO = #{vhclNo} /*차량번호*/
		AND		A.FINE_SEQ = #{fineSeq} /*범칙금일련번호*/
		AND		A.SEND_PLC_CD = B.SEND_PLC_CD 
		AND		A.SEND_PLC_SEQ = B.SEND_PLC_SEQ
		AND		A.VHCL_NO = C.VHCL_NO 
		AND 	A.VLT_DT >= C.LOAN_DT
		AND 	(A.VLT_DT < C.TMNT_DT OR C.TMNT_DT = '')
		]]>
	</select>

	<!-- Retrieve : 다운로드(한국도로공사) 조회 -->
	<select id="retrieveDownloadEx" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	CONCAT(C.LOAN_NO, '-', C.LOAN_SEQ) AS col1 /*대출번호*/
				,C.CS_NM AS col2 /*고객명*/
				/*상품명은 업체별 DB 기준이 다르기 때문에 기준 확인 필요*/
				,CASE WHEN C.GD_CD LIKE 'RC%' THEN '렌터카'
					  WHEN C.GD_CD LIKE 'AT%' THEN '리스'
					  ELSE ''
				END AS col3 /*상품명*/
				,CONCAT(CONCAT(SUBSTRING(A.VLT_DT, 1, 4), '-', SUBSTRING(A.VLT_DT, 5, 2), '-', SUBSTRING(A.VLT_DT, 7, 2))
						, ' '
						, CONCAT(SUBSTRING(A.VLT_ATIME, 1, 2), ':', SUBSTRING(A.VLT_ATIME, 3, 2))
				) AS col4 /*위반일시*/
				,CASE WHEN A.RCPT_DT != ''
					  THEN CONCAT(SUBSTRING(A.RCPT_DT , 1, 4),
		       				  	  '-',
		       				  	  SUBSTRING(A.RCPT_DT , 5, 2), 
		       				  	  '-',
		       				  	  SUBSTRING(A.RCPT_DT , 7, 2))
					  ELSE ''
				END AS col5 /*접수일자*/
				,CASE WHEN A.PYMT_DDAY_DT != ''
					  THEN CONCAT(SUBSTRING(A.PYMT_DDAY_DT , 1, 4),
		       				  	  '-',
		       				  	  SUBSTRING(A.PYMT_DDAY_DT , 5, 2), 
		       				  	  '-',
		       				  	  SUBSTRING(A.PYMT_DDAY_DT , 7, 2))
					  ELSE ''
				END AS col6 /*납부기한일자*/
				,A.VHCL_NO AS col7 /*차량번호*/
				,(SELECT X.CD_NM FROM BIZ_COMN_CD_DTL X WHERE X.COMN_CD_ENG_NM = 'VLT_KIND_CD' AND X.CD_VAL = A.VLT_KIND_CD) AS col8 /*위반종류*/
				,A.VLT_CTS AS col9 /*위반내용*/
				,B.NTCDOC_SEND_PLC_NM AS col10 /*발송처*/
				,CONCAT(C.CS_ADDR, CASE WHEN C.CS_ADDR_DTL != '' THEN CONCAT(', ', C.CS_ADDR_DTL) ELSE '' END) AS col11 /*청구주소*/
				/*도로명의 경우 업체별 주소 기준이 다르므로 확인 필요 (일단은 임시로 지번주소와 동일하게 넣고 테스트~)*/
				,CONCAT(C.CS_ADDR, CASE WHEN C.CS_ADDR_DTL != '' THEN CONCAT(', ', C.CS_ADDR_DTL) ELSE '' END) AS col12 /*청구주소(도로명)*/
				/*고객연락처의 경우 업체별 DB 상태가 다르므로 확인 필요*/
				,CONCAT(SUBSTRING(C.TEL_NO , 1, 3),
					  	'-',
					  	SUBSTRING(C.TEL_NO , 4, 4), 
					  	'-',
					  	SUBSTRING(C.TEL_NO , 8, 4)) AS col13 /*고객전화번호*/
				,A.FINE_SEQ /*범칙금일련번호(정렬용)*/
		FROM 	BIZ_FINE_MAS A /*BIZ_범칙금기본*/
				,BIZ_FINE_SEND_PLC_STD_MNGE B /*BIZ_범칙금관공서기준관리*/
				,BIZ_LOAN_MAS C /*BIZ_대출기본*/
		WHERE 	A.VLT_DT = #{vltDt} /*위반일자*/
		AND		A.VLT_ATIME = #{vltAtime} /*위반시각*/
		AND		A.VHCL_NO = #{vhclNo} /*차량번호*/
		AND		A.FINE_SEQ = #{fineSeq} /*범칙금일련번호*/
		AND		A.SEND_PLC_CD = B.SEND_PLC_CD 
		AND		A.SEND_PLC_SEQ = B.SEND_PLC_SEQ
		AND		A.VHCL_NO = C.VHCL_NO 
		AND 	A.VLT_DT >= C.LOAN_DT
		AND 	(A.VLT_DT < C.TMNT_DT OR C.TMNT_DT = '')
		]]>
	</select>

	<!-- Retrieve : 다운로드(OCR) 조회 -->
	<select id="retrieveDownloadOCR" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	A.VHCL_NO AS col1 /*차량번호*/
				,CONCAT(CONCAT(SUBSTRING(A.VLT_DT, 1, 4), '-', SUBSTRING(A.VLT_DT, 5, 2), '-', SUBSTRING(A.VLT_DT, 7, 2))
						, ' '
						, CONCAT(SUBSTRING(A.VLT_ATIME, 1, 2), ':', SUBSTRING(A.VLT_ATIME, 3, 2))
				) AS col2 /*위반일시*/
				,C.CS_NM AS col3 /*임차인명*/
				/*각 연락처는 업체별 DB 기준이 다르기 때문에 기준 확인 필요(임시 컬럼 세팅)*/
				,CONCAT(SUBSTRING(C.TEL_NO , 1, 3),
					  	'-',
					  	SUBSTRING(C.TEL_NO , 4, 4), 
					  	'-',
					  	SUBSTRING(C.TEL_NO , 8, 4)) AS col4 /*연락처*/
				,CONCAT(SUBSTRING(C.TEL_NO , 1, 3),
					  	'-',
					  	SUBSTRING(C.TEL_NO , 4, 4), 
					  	'-',
					  	SUBSTRING(C.TEL_NO , 8, 4)) AS col5 /*자택연락처*/
				,CONCAT(SUBSTRING(C.TEL_NO , 1, 3),
					  	'-',
					  	SUBSTRING(C.TEL_NO , 4, 4), 
					  	'-',
					  	SUBSTRING(C.TEL_NO , 8, 4)) AS col6 /*직장연락처*/
				,CONCAT(C.CS_ADDR, CASE WHEN C.CS_ADDR_DTL != '' THEN CONCAT(', ', C.CS_ADDR_DTL) ELSE '' END) AS col7 /*청구주소*/
				,CONCAT(SUBSTRING(C.LOAN_DT , 1, 4),
					  	'-',
					  	SUBSTRING(C.LOAN_DT , 5, 2), 
					  	'-',
					  	SUBSTRING(C.LOAN_DT , 7, 2),
					  	' ~ ',
					  	SUBSTRING(C.MTRT_DT , 1, 4),
					  	'-',
					  	SUBSTRING(C.MTRT_DT , 5, 2), 
					  	'-',
					  	SUBSTRING(C.MTRT_DT , 7, 2)) AS col8 /*임차기간*/
				,DOC_FINE_NO1 /*문서범칙금번호1(정렬용)*/
		FROM 	BIZ_FINE_MAS A /*BIZ_범칙금기본*/
				,BIZ_FINE_SEND_PLC_STD_MNGE B /*BIZ_범칙금관공서기준관리*/
				,BIZ_LOAN_MAS C /*BIZ_대출기본*/
		WHERE 	A.VLT_DT = #{vltDt} /*위반일자*/
		AND		A.VLT_ATIME = #{vltAtime} /*위반시각*/
		AND		A.VHCL_NO = #{vhclNo} /*차량번호*/
		AND		A.FINE_SEQ = #{fineSeq} /*범칙금일련번호*/
		AND		A.SEND_PLC_CD = B.SEND_PLC_CD 
		AND		A.SEND_PLC_SEQ = B.SEND_PLC_SEQ
		AND		A.VHCL_NO = C.VHCL_NO 
		AND 	A.VLT_DT >= C.LOAN_DT
		AND 	(A.VLT_DT < C.TMNT_DT OR C.TMNT_DT = '')
		]]>
	</select>

	<!-- Retrieve : 다운로드(카택스) 조회 -->
	<select id="retrieveDownloadCartax" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	A.DOC_FINE_NO1 AS col1 /*단속일련번호*/
				,A.DOC_FINE_NO3 AS col2 /*자치구*/
				,A.VLT_CTS AS col3 /*위반내역*/
				,A.VHCL_NO AS col4 /*차량번호*/
				,A.DOC_FINE_NO2 AS col5 /*회사명*/
				,CONCAT(CONCAT(SUBSTRING(A.VLT_DT, 1, 4), '-', SUBSTRING(A.VLT_DT, 5, 2), '-', SUBSTRING(A.VLT_DT, 7, 2))
						, ' '
						, CONCAT(SUBSTRING(A.VLT_ATIME, 1, 2), ':', SUBSTRING(A.VLT_ATIME, 3, 2), ':', SUBSTRING(A.VLT_ATIME, 5, 2))
				) AS col6 /*단속일시*/
				,A.DOC_FINE_NO4 AS col7 /*고지날짜*/
				,CASE WHEN A.PYMT_DDAY_DT = '' THEN '0'
					  ELSE A.PYMT_DDAY_DT
				END AS col8 /*납부기한*/
				,FORMAT(A.FINE_AMT, 0) AS col9 /*금액*/
				,SUBSTRING_INDEX(A.VLT_PNT, ' / ', 1)  AS col10 /*단속주소*/
				,CASE WHEN LOCATE(' / ', A.VLT_PNT) > 0 THEN SUBSTRING_INDEX(A.VLT_PNT, ' / ', -1)
					  ELSE ''
				END AS col11 /*메모*/
				,CASE WHEN C.CS_TYP_CD IN ('1', '2') THEN '개인'
					  WHEN C.CS_TYP_CD IN ('3', '4') THEN '법인'
					  WHEN C.CS_TYP_CD = '5' THEN '외국인'
					  ELSE ''
				END AS col12 /*납세자유형*/
				/*개인, 개인사업자: 고객 실명번호(렌터카 뒷자리 마스킹)
				 *법인, 법인사업장: 법인번호
				 *외국인: 외국인번호(렌터카 뒷자리 마스킹)*/
				,CASE WHEN C.CS_TYP_CD IN ('1', '2') THEN IF(C.GD_CD LIKE 'RC%', 
															CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-*******'),
															CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-', SUBSTRING(C.RNM_NO , 7, 7)))
					  WHEN C.CS_TYP_CD IN ('3', '4') THEN CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-', SUBSTRING(C.RNM_NO , 7, 7))
					  WHEN C.CS_TYP_CD = '5' THEN IF(C.GD_CD LIKE 'RC%', 
													CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-*******'),
													CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-', SUBSTRING(C.RNM_NO , 7, 7)))
					  ELSE ''
				END AS col13 /*사업자/법인/주민번호*/
				/*개인, 개인사업자, 외국인: (대표자)운전면허번호
				 *법인, 법인사업장: 공란*/
				,CASE WHEN C.CS_TYP_CD IN ('1', '2', '5') THEN CONCAT(SUBSTRING(C.DRV_LIC_NO , 1, 2),
									       				  			  '-',
									       				  			  SUBSTRING(C.DRV_LIC_NO , 3, 2),
									       				  			  '-',
									       				  			  SUBSTRING(C.DRV_LIC_NO , 5, 6),
									       				  			  '-',
									       				  			  SUBSTRING(C.DRV_LIC_NO , 11, 2))
					  ELSE ''
				END AS col14 /*운전면허번호*/
				/*개인, 개인사업자, 외국인: 고객명
				 *법인: 법인사업장명
				 *업체별 DB 상황이 다르므로 확인 필요*/
				,CASE WHEN C.CS_TYP_CD = '3' THEN C.CS_NM /*임시세팅*/
					  ELSE C.CS_NM
				END AS col15 /*운행자명*/
				/*대여시작일(대출일자)의 경우엔 재렌트는 기대출의 대출일자를 가져와야 할 수 있으므로 업체별 기준 확인 필요*/
				,CONCAT(SUBSTRING(C.LOAN_DT , 1, 4),
					  	'-',
					  	SUBSTRING(C.LOAN_DT , 5, 2), 
					  	'-',
					  	SUBSTRING(C.LOAN_DT , 7, 2)) AS col16 /*대여시작일*/
				/*해지건은 해지일자 표시하고 나머지는 만기일자 표시하는지 업체별 확인 필요*/
				,CONCAT(SUBSTRING(C.MTRT_DT , 1, 4),
					  	'-',
					  	SUBSTRING(C.MTRT_DT , 5, 2), 
					  	'-',
					  	SUBSTRING(C.MTRT_DT , 7, 2)) AS col17 /*대여종료일*/
			  	/*법인은 본사, 나머지는 주민등록지의 우편번호 기재
			  	 *업체별 DB 상황이 다르므로 확인 필요*/
				,CASE WHEN C.CS_TYP_CD = '3' THEN '11111' /*임시세팅*/
					  ELSE '00000'
				END AS col18 /*운전자 우편번호*/
				,C.CS_ADDR AS col19 /*주소*/
				,C.CS_ADDR_DTL AS col20 /*상세주소*/
				,CONCAT(SUBSTRING(C.TEL_NO , 1, 3),
					  	'-',
					  	SUBSTRING(C.TEL_NO , 4, 4), 
					  	'-',
					  	SUBSTRING(C.TEL_NO , 8, 4)) AS col21 /*운행자전화번호*/
				,A.FINE_SEQ /*범칙금일련번호(정렬용)*/
		FROM 	BIZ_FINE_MAS A /*BIZ_범칙금기본*/
				,BIZ_FINE_SEND_PLC_STD_MNGE B /*BIZ_범칙금관공서기준관리*/
				,BIZ_LOAN_MAS C /*BIZ_대출기본*/
		WHERE 	A.VLT_DT = #{vltDt} /*위반일자*/
		AND		A.VLT_ATIME = #{vltAtime} /*위반시각*/
		AND		A.VHCL_NO = #{vhclNo} /*차량번호*/
		AND		A.FINE_SEQ = #{fineSeq} /*범칙금일련번호*/
		AND		A.SEND_PLC_CD = B.SEND_PLC_CD 
		AND		A.SEND_PLC_SEQ = B.SEND_PLC_SEQ
		AND		A.VHCL_NO = C.VHCL_NO 
		AND 	A.VLT_DT >= C.LOAN_DT
		AND 	(A.VLT_DT < C.TMNT_DT OR C.TMNT_DT = '')
		]]>
	</select>

	<!-- Retrieve : 다운로드(PDF) 조회 -->
	<select id="retrieveDownloadPdf" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	/*PDF 1페이지 담당자명은 해당 범칙금의 최종수정자 이름을 가져오지만.. 사용 환경에 따라 다를듯.. 일단 레포트에 고정함 (내선번호도 동일)*/
				B.NTCDOC_SEND_PLC_NM AS SEND_PLC_NM /*발송처명*/
				/*개인사업자: 대표자명
				 *그 외: 법인명 또는 고객명
				 *사용환경에 따라 다름 변경 필요*/
				,CASE WHEN C.CS_TYP_CD = '2' THEN C.CS_NM 
					  ELSE C.CS_NM
				END AS CS_NM /*고객명*/
				,A.VHCL_NO /*차량번호*/
				,C.CS_ADDR /*고객주소*/
				,C.CS_ADDR_DTL /*고객주소상세*/
				/*개인: 고객 실명번호(렌터카 뒷자리 마스킹)
				 *개인사업자, 법인, 법인사업장: 사업자번호
				 *외국인: 외국인번호(렌터카 뒷자리 마스킹)
				 *사용환경 DB에 따라 사업자번호 필드 변경 해야함. */
				,CASE WHEN C.CS_TYP_CD = '1' THEN IF(C.GD_CD LIKE 'RC%', 
													CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-*******'),
													CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-', SUBSTRING(C.RNM_NO , 7, 7)))
					  WHEN C.CS_TYP_CD IN ('2', '3', '4') THEN CONCAT(SUBSTRING(C.RNM_NO , 1, 3), '-', SUBSTRING(C.RNM_NO , 4, 2), '-', SUBSTRING(C.RNM_NO , 6, 5))
					  WHEN C.CS_TYP_CD = '5' THEN IF(C.GD_CD LIKE 'RC%', 
													CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-*******'),
													CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-', SUBSTRING(C.RNM_NO , 7, 7)))
					  ELSE ''
				END AS RNM_NO /*실명번호*/
				/*개인: 고객 실명번호(렌터카 뒷자리 마스킹)
				 *개인사업자: 실명번호 / 사업자번호
				 *법인, 법인사업장: 사업자번호
				 *외국인: 외국인번호(렌터카 뒷자리 마스킹)
				 *사용환경 DB에 따라 사업자번호 필드 변경 해야함. */
				,CASE WHEN C.CS_TYP_CD = '1' THEN IF(C.GD_CD LIKE 'RC%', 
													CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-*******'),
													CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-', SUBSTRING(C.RNM_NO , 7, 7)))
					  WHEN C.CS_TYP_CD = '2' THEN CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-', SUBSTRING(C.RNM_NO , 7, 7), '/', SUBSTRING(C.RNM_NO , 1, 3), '-', SUBSTRING(C.RNM_NO , 4, 2), '-', SUBSTRING(C.RNM_NO , 6, 5))
					  WHEN C.CS_TYP_CD IN ('3', '4') THEN CONCAT(SUBSTRING(C.RNM_NO , 1, 3), '-', SUBSTRING(C.RNM_NO , 4, 2), '-', SUBSTRING(C.RNM_NO , 6, 5))
					  WHEN C.CS_TYP_CD = '5' THEN IF(C.GD_CD LIKE 'RC%', 
													CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-*******'),
													CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-', SUBSTRING(C.RNM_NO , 7, 7)))
					  ELSE ''
				END AS RNM_NO2 /*실명번호2(리스렌터카 이용자정보)*/
				/*법인, 법인사업장: 법인번호
				 *사용환경 DB에 따라 법인번호로 필드 변경 해야함. */
				,CASE WHEN C.CS_TYP_CD IN ('3', '4') THEN CONCAT(SUBSTRING(C.RNM_NO , 1, 6), '-', SUBSTRING(C.RNM_NO , 7, 7))
					  ELSE ''
				END AS CS_BRNO /*고객법인번호*/
				/*개인, 개인사업자, 외국인: (대표자)운전면허번호
				 *법인, 법인사업장: 공란*/
				,CASE WHEN C.CS_TYP_CD IN ('1', '2', '5') THEN CONCAT(SUBSTRING(C.DRV_LIC_NO , 1, 2),
									       				  			  '-',
									       				  			  SUBSTRING(C.DRV_LIC_NO , 3, 2),
									       				  			  '-',
									       				  			  SUBSTRING(C.DRV_LIC_NO , 5, 6),
									       				  			  '-',
									       				  			  SUBSTRING(C.DRV_LIC_NO , 11, 2))
					  ELSE ''
				END AS DRV_LIC_NO /*운전면허번호*/
				,CONCAT(CONCAT(SUBSTRING(A.VLT_DT, 1, 4), '-', SUBSTRING(A.VLT_DT, 5, 2), '-', SUBSTRING(A.VLT_DT, 7, 2))
						, ' '
						, CONCAT(SUBSTRING(A.VLT_ATIME, 1, 2), ':', SUBSTRING(A.VLT_ATIME, 3, 2), ':', SUBSTRING(A.VLT_ATIME, 5, 2))
				) AS VLT_TS /*위반일시*/
				,DATE_FORMAT(CURRENT_TIMESTAMP, '%Y-%m-%d %H:%i:%s') AS AUTH_DT /*작성일자*/
				/*사용환경 DB에 따라 다름.. 법인은 직장>사업장>본사>법인담당자 순서로 존재하는 연락처 기재 조건 등..*/
				,CONCAT(SUBSTRING(C.TEL_NO , 1, 3),
					  	'-',
					  	SUBSTRING(C.TEL_NO , 4, 4), 
					  	'-',
					  	SUBSTRING(C.TEL_NO , 8, 4)) AS TEL_NO /*연락처*/
				/*대여시작일(대출일자)의 경우엔 재렌트는 기대출의 대출일자를 가져와야 할 수 있으므로 업체별 기준 확인 필요*/
				/*해지건은 해지일자 표시하고 나머지는 만기일자 표시하는지 업체별 확인 필요*/
				,CONCAT(SUBSTRING(C.LOAN_DT , 1, 4),
					  	'-',
					  	SUBSTRING(C.LOAN_DT , 5, 2), 
					  	'-',
					  	SUBSTRING(C.LOAN_DT , 7, 2),
					  	'~',
					  	SUBSTRING(C.MTRT_DT , 1, 4),
					  	'-',
					  	SUBSTRING(C.MTRT_DT , 5, 2), 
					  	'-',
					  	SUBSTRING(C.MTRT_DT , 7, 2)) AS LOAN_TRM /*대출기간*/
				,CASE A.FINE_UPLOAD_CD WHEN '3' THEN SUBSTRING_INDEX(A.VLT_CTS, '^', 1) 
									 ELSE A.VLT_CTS
				END AS VLT_CTS /*위반내용*/
				/*사용자 DB에 따라 차종명 가져와야함.*/
				,'현대 아반떼AD' AS VHCL_MDL /*차종*/
				,SUBSTRING_INDEX(SUBSTRING_INDEX(A.VLT_PNT, '위반장소:', -1), '/', 1) AS VLT_PNT /*위반장소*/
				,CASE WHEN C.MTRT_DT < A.VLT_DT THEN '계약기간 종료 후 종결 처리 지연으로 위반일 계약자 이용.'
					  ELSE ''
				END AS REM /*비고*/
				
				/* 차량 소유자 정보 */
				,'비즈시스템' AS BIZ_NM /*차량소유자정보_상호명*/
				,'000-00-00000' AS BIZ_BRNO /*차량소유자정보_사업자번호*/
				,'000000-0000000' AS BIZ_CRNO /*차량소유자정보_법인번호*/
				,'서울 영등포구 양평로 149 A동 505호(양평동5가, 선유도우림라이온스밸리 A)' AS BIZ_ADDR /*차량소유자정보_사업장주소*/
				,'홍길동' AS BIZ_OFIC /*차량소유자정보_담당자*/
				,#{ntcdocDocNo} AS NTCDOC_DOC_NO /*고지서문서번호*/
				,A.FINE_SEQ /*범칙금일련번호*/
		FROM 	BIZ_FINE_MAS A /*BIZ_범칙금기본*/
				,BIZ_FINE_SEND_PLC_STD_MNGE B /*BIZ_범칙금관공서기준관리*/
				,BIZ_LOAN_MAS C /*BIZ_대출기본*/
		WHERE 	A.VLT_DT = #{vltDt} /*위반일자*/
		AND		A.VLT_ATIME = #{vltAtime} /*위반시각*/
		AND		A.VHCL_NO = #{vhclNo} /*차량번호*/
		AND		A.FINE_SEQ = #{fineSeq} /*범칙금일련번호*/
		AND		A.SEND_PLC_CD = B.SEND_PLC_CD 
		AND		A.SEND_PLC_SEQ = B.SEND_PLC_SEQ
		AND		A.VHCL_NO = C.VHCL_NO 
		AND 	A.VLT_DT >= C.LOAN_DT
		AND 	(A.VLT_DT < C.TMNT_DT OR C.TMNT_DT = '')
		]]>
	</select>

	<!-- Retrieve : 공문 문서번호 채번 -->
	<select id="retrieveNtcdocDocNo" parameterType="egovframework.penalty.FineMngeVO" resultMap="FineMngeVO">
		<![CDATA[
		SELECT 	CONCAT('비즈시스템(IT팀)-'
						, DATE_FORMAT(CURRENT_DATE, '%y%m%d')
						, '-'
						, '0'
						, #{sendPlcCd}
						, '-'
						, IFNULL(
							(SELECT LPAD(MAX(CAST(SUBSTRING(X.NTCDOC_DOC_NO, -5) AS UNSIGNED)) + 1, 5, '0')
							FROM BIZ_FINE_MAS X
							WHERE SUBSTRING(X.NTCDOC_DOC_NO, 1, LENGTH(X.NTCDOC_DOC_NO) - 5) = CONCAT('비즈시스템(IT팀)-', DATE_FORMAT(CURRENT_DATE, '%Y-%m-%d'), '-0', #{sendPlcCd}))
						  ,'00001')
					  ) AS NTCDOC_DOC_NO /*고지서문서번호*/
		FROM 	BIZ_FINE_MAS A /*BIZ_범칙금기본*/
		LIMIT 1
		]]>
	</select>
	
	<!-- Update : 공문 문서번호 업데이트 -->
	<update id="updateNtcdocDocNo" parameterType="egovframework.penalty.FineMngeVO">
		<![CDATA[
		UPDATE	BIZ_FINE_MAS /*BIZ_범칙금기본*/
		SET		NTCDOC_DOC_NO = #{ntcdocDocNo} /*고지서문서번호*/
				, LAST_CHNGMN_ID = #{sessionId} /*최종변경자ID*/
				, LAST_CHGE_IP_ADDR = #{sessionIp} /*최종변경IP주소*/
		WHERE	VLT_DT = #{vltDt}
		AND		VLT_ATIME = #{vltAtime}
		AND		VHCL_NO = #{vhclNo}
		AND		FINE_SEQ = #{fineSeq}
		]]>
	</update>
</mapper>