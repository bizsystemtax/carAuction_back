<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="carAucInfDAO">
	
	<resultMap id="CarInfoVO" type="egovframework.carauction.CarInfoVO">
		<result property="rowNum" column="RNUM"/>
		<result property="aucRegNo" column="AUC_REG_NO"/>
		<result property="carModelNm" column="CAR_MODEL_NM"/>
		<result property="carLevelNm" column="CAR_LEVEL_NM"/>
		<result property="aucCarMakeYr" column="AUC_CAR_MAKE_YR"/>
		<result property="fuelType" column="FUEL_TYPE"/>
		<result property="aucCarDrvDis" column="AUC_CAR_DRV_DIS"/>
		<result property="carTransGb" column="CAR_TRANS_GB"/>
		<result property="bidPlnPrice" column="BID_PLN_PRICE"/>
		<result property="aucCarCc" column="AUC_CAR_CC"/>
		<result property="locImpGb" column="LOC_IMP_GB"/>
		<result property="entryDate" column="ENTRY_DATE"/>
		<result property="bidExpDt" column="BID_EXP_DT"/>
		<result property="entryIdno" column="ENTRY_IDNO"/>
	</resultMap>

	<!-- *******************************************************************************************************
	 	차량 경매 정보
	 ******************************************************************************************************* -->
	
	<!-- 제조사 목록 조회 -->
	<select id="findAllManufacturers" resultType="hashmap">
		<![CDATA[
			SELECT CODE_HNAME as brHname
			FROM CA_CMM_CD
			WHERE CONCAT(CODE_FIRST, code_second) = 'C01'
			ORDER BY CODE_HNAME
		]]>
	</select>

	<!-- 모델 목록 조회 -->
	<select id="findAllModels" resultType="hashmap">
		<![CDATA[
			SELECT DISTINCT CAR_MODEL_NM as modelName
			FROM CA_CAR_INF
			WHERE CAR_MODEL_NM IS NOT NULL AND CAR_MODEL_NM != ''
			ORDER BY CAR_MODEL_NM
		]]>
	</select>

	<!-- 제조사별 모델 목록 조회  -->
	<select id="findModelsByManufacturer" parameterType="String" resultType="hashmap">
		<![CDATA[
			SELECT DISTINCT car.CAR_MODEL_NM as modelName
			FROM CA_CAR_INF car
			INNER JOIN CA_CMM_CD cd ON car.MKR_CD = cd.CODE_NO
			WHERE cd.CODE_HNAME = #{manufacturer}
			AND CONCAT(cd.CODE_FIRST, cd.CODE_SECOND) = 'C01'
			AND car.CAR_MODEL_NM IS NOT NULL AND car.CAR_MODEL_NM != ''
			ORDER BY car.CAR_MODEL_NM
		]]>
	</select>

	<!-- 세부모델 목록 조회 -->
	<select id="findAllSubModels" resultType="hashmap">
		<![CDATA[
			SELECT DISTINCT CAR_LEVEL_NM as subModelName
			FROM CA_CAR_INF
			WHERE CAR_LEVEL_NM IS NOT NULL AND CAR_LEVEL_NM != ''
			ORDER BY CAR_LEVEL_NM
		]]>
	</select>

	<!-- 제조사+모델별 세부모델 조회 -->
	<select id="findSubModelsByManufacturerAndModel" parameterType="egovframework.carauction.CarSearchCriteriaVO" resultType="hashmap">
		<![CDATA[
			SELECT DISTINCT car.CAR_LEVEL_NM as subModelName
			FROM CA_CAR_INF car
			INNER JOIN CA_CMM_CD cd ON car.MKR_CD = cd.CODE_NO
			WHERE 1=1
			AND CONCAT(cd.CODE_FIRST, cd.CODE_SECOND) = 'C01'
			AND car.CAR_LEVEL_NM IS NOT NULL AND car.CAR_LEVEL_NM != ''
		]]>
		
		<if test="manufacturer != null and manufacturer != '' and manufacturer != '전체'">
			AND cd.CODE_HNAME = #{manufacturer}
		</if>
		
		<if test="model != null and model != '' and model != '전체'">
			AND car.CAR_MODEL_NM = #{model}
		</if>
		
		ORDER BY car.CAR_LEVEL_NM
	</select>

	<!-- 연료타입 목록 조회  -->
	<select id="findAllFuelTypes" resultType="hashmap">
		<![CDATA[
			SELECT DISTINCT CODE_HNAME as fuelTypeName
			FROM CA_CMM_CD
			WHERE CONCAT(CODE_FIRST, code_second) = 'C04'
			ORDER BY CODE_HNAME
		]]>
	</select>

	<!-- 등록회원사 목록 조회  -->
	<select id="findAllRegistrationCompanies" resultType="hashmap">
		<![CDATA[
			SELECT DISTINCT CODE_HNAME as registrationCompanyName
			FROM CA_CMM_CD
			WHERE CONCAT(CODE_FIRST, CODE_SECOND) = 'U01'
			AND CODE_NO IS NOT NULL
			ORDER BY CODE_NO
		]]>
	</select>

	<!-- 차량 조회 쿼리 -->
	<select id="findCarsWithConditions" parameterType="egovframework.carauction.CarSearchCriteriaVO" resultMap="CarInfoVO">
		<![CDATA[
			SELECT ROW_NUMBER() OVER (ORDER BY auc.ENTRY_DATE DESC) AS RNUM,
			       auc.AUC_REG_NO,
			       CONCAT(
			           (SELECT CODE_HNAME FROM CA_CMM_CD WHERE code_no = car.MKR_CD AND CONCAT(CODE_FIRST, code_second) = 'C01'),
			           ' ',
			           car.CAR_MODEL_NM
			       ) AS CAR_MODEL_NM,
			       car.CAR_LEVEL_NM,
			       auc.AUC_CAR_MAKE_YR,
			       (SELECT CODE_HNAME FROM CA_CMM_CD WHERE code_no = car.CAR_ENG_CD AND CONCAT(CODE_FIRST, code_second) = 'C04') AS FUEL_TYPE,
			       auc.AUC_CAR_DRV_DIS,
			       car.CAR_TRANS_GB,
			       auc.BID_PLN_PRICE,
			       auc.AUC_CAR_CC,
			       auc.LOC_IMP_GB,
			       auc.ENTRY_DATE,
			       DATE_FORMAT(STR_TO_DATE(auc.BID_EXP_DT, '%Y%m%d'), '%Y-%m-%d') AS BID_EXP_DT,
			       auc.ENTRY_IDNO
			FROM CA_CAR_AUC_INF auc
			INNER JOIN CA_CAR_INF car ON auc.CAR_MAIN_NO = car.CAR_MAIN_NO
            AND auc.AUC_PROG_YN = 'Y'
			WHERE 1=1
		]]>
		
		<!-- 제조사 조건 -->
		<if test="manufacturer != null and manufacturer != '' and manufacturer != '전체'">
			AND (SELECT CODE_HNAME FROM CA_CMM_CD WHERE code_no = car.MKR_CD AND CONCAT(CODE_FIRST, code_second) = 'C01') = #{manufacturer}
		</if>

		<!-- 모델 조건 -->
		<if test="model != null and model != '' and model != '전체'">
			AND car.CAR_MODEL_NM = #{model}
		</if>

		<!-- 세부모델 조건 -->
		<if test="subModel != null and subModel != '' and subModel != '전체'">
			AND car.CAR_LEVEL_NM = #{subModel}
		</if>

		<!-- 연료 조건 -->
		<if test="fuelType != null and fuelType != '' and fuelType != '전체'">
			AND (SELECT CODE_HNAME FROM CA_CMM_CD WHERE code_no = car.CAR_ENG_CD AND CONCAT(CODE_FIRST, code_second) = 'C04') = #{fuelType}
		</if>

		<!-- 등록회원사 조건 -->
		<if test="registrationCompany != null and registrationCompany != '' and registrationCompany != '전체'">
			AND (SELECT CODE_HNAME FROM CA_CMM_CD WHERE CODE_NO = auc.ENTRY_IDNO AND CONCAT(CODE_FIRST, CODE_SECOND) = 'U01') = #{registrationCompany}
		</if>

		<!-- 연식 조건 -->
		<if test="startYear != null and startYear != ''">
			AND auc.AUC_CAR_MAKE_YR &gt;= #{startYear}
		</if>
		<if test="endYear != null and endYear != ''">
			AND auc.AUC_CAR_MAKE_YR &lt;= #{endYear}
		</if>

		<!-- 등록일 조건 -->
		<if test="startDate != null and startDate != ''">
			AND auc.ENTRY_DATE &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND auc.ENTRY_DATE &lt;= #{endDate}
		</if>

		<!-- 주행거리 조건 -->
		<if test="mileageStart != null and mileageStart != ''">
			AND auc.AUC_CAR_DRV_DIS &gt;= #{mileageStart}
		</if>
		<if test="mileageEnd != null and mileageEnd != ''">
			AND auc.AUC_CAR_DRV_DIS &lt;= #{mileageEnd}
		</if>

		ORDER BY auc.ENTRY_DATE DESC
	</select>
	
	<!-- 차량 상세 정보 조회 (키값 기반) -->
<select id="findCarByAucRegNo" parameterType="String" resultMap="CarInfoVO">
    <![CDATA[
        SELECT ROW_NUMBER() OVER (ORDER BY auc.ENTRY_DATE DESC) AS RNUM,
               auc.AUC_REG_NO,
               CONCAT(
                   (SELECT CODE_HNAME FROM CA_CMM_CD WHERE code_no = car.MKR_CD AND CONCAT(CODE_FIRST, code_second) = 'C01'),
                   ' ',
                   car.CAR_MODEL_NM
               ) AS CAR_MODEL_NM,
               car.CAR_LEVEL_NM,
               auc.AUC_CAR_MAKE_YR,
               (SELECT CODE_HNAME FROM CA_CMM_CD WHERE code_no = car.CAR_ENG_CD AND CONCAT(CODE_FIRST, code_second) = 'C04') AS FUEL_TYPE,
               auc.AUC_CAR_DRV_DIS,
               car.CAR_TRANS_GB,
               auc.BID_PLN_PRICE,
               auc.AUC_CAR_CC,
               auc.LOC_IMP_GB,
               auc.ENTRY_DATE,
               DATE_FORMAT(STR_TO_DATE(auc.BID_EXP_DT, '%Y%m%d'), '%Y-%m-%d') AS BID_EXP_DT,
               auc.ENTRY_IDNO
        FROM CA_CAR_AUC_INF auc
        LEFT JOIN CA_CAR_INF car ON auc.CAR_MAIN_NO = car.CAR_MAIN_NO
        WHERE auc.AUC_REG_NO = #{aucRegNo}
    ]]>
</select>

<!-- 은행 목록 조회 -->
<select id="findAllBanks" resultType="String">
    <![CDATA[
        SELECT DISTINCT MNGR_BANK_NM
        FROM CA_MNGR_ACC_INF
        WHERE MNGR_BANK_NM IS NOT NULL
        AND USE_YN = 'Y'
        ORDER BY MNGR_BANK_NM
    ]]>
</select>

<!-- 은행별 계좌번호 목록 조회 -->
<select id="findAccountsByBank" parameterType="String" resultType="String">
    <![CDATA[
        SELECT MNGR_ACC_NO
        FROM CA_MNGR_ACC_INF
        WHERE MNGR_BANK_NM = #{bankName}
        AND USE_YN = 'Y'
        ORDER BY MNGR_ACC_NO
    ]]>
</select>
	
	<!-- *******************************************************************************************************
	 	차량 판매 정보
	 ******************************************************************************************************* -->
	 
</mapper>