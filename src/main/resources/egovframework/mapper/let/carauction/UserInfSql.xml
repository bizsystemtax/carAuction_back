<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="UserInfDAO">
	<resultMap id="UserInfVO" type="egovframework.carauction.UserInfVO">
		<!-- IN -->
		<result property="inStartDate" column="IN_START_DATE"/>
		<result property="inEndDate" column="IN_END_DATE"/>
		<result property="inUserGbCd" column="IN_USER_GB_CD"/>
		<result property="inUserNm" column="IN_USER_NM"/>
		<result property="inUserId" column="IN_USER_ID"/>
		<result property="inUserPw" column="IN_USER_PW"/>

		<!-- OUT -->
		<result property="num" column="NUM"/>
		<result property="userGbNm" column="USER_GB_NM"/>
		<result property="userNm" column="USER_NM"/>
		<result property="contNm" column="CONT_NM"/>
		<result property="contCellno" column="CONT_CELLNO"/>
		<result property="contEmailAddr" column="CONT_EMAIL_ADDR"/>
		<result property="compAddr" column="COMP_ADDR"/>
		<result property="compTelno" column="COMP_TELNO"/>
		<result property="compFaxno" column="COMP_FAXNO"/>
		<result property="compHmpgAddr" column="COMP_HMPG_ADDR"/>
		<result property="refdBank" column="REFD_BANK"/>
		<result property="refdAcc" column="REFD_ACC"/>
		<result property="refdAccAhdrNm" column="REFD_ACC_AHDR_NM"/>
		<result property="aucEntryCnt" column="AUC_ENTRY_CNT"/>
		<result property="aucBidProgCnt" column="AUC_BID_PROG_CNT"/>
		<result property="aucSbidCnt" column="AUC_SBID_CNT"/>
		<result property="bidEntryCnt" column="BID_ENTRY_CNT"/>
		<result property="bidSbidCnt" column="BID_SBID_CNT"/>
		<result property="regDate" column="REG_DATE"/>
		<result property="userId" column="USER_ID"/>
		<result property="userPw" column="USER_PW"/>
		
		<!-- 회원관리 회원 현황 조회 파라미터 -->
		<result property="inRegStartDate" column="IN_REG_START_DATE"/>
		<result property="inRegEndDate" column="IN_REG_END_DATE"/>
		<result property="inSearchCd" column="IN_SEARCH_CD"/>
		<result property="inSearchUserId" column="IN_SEARCH_USER_ID"/>
		<result property="carListNo" column="NUM"/>
		<result property="carNo" column="CAR_NO"/>
		<result property="carNm" column="CAR_NM"/>
		<result property="carOption" column="AUC_CAR_CMNT"/>
		<result property="carYear" column="AUC_CAR_MAKE_YR"/>
		<result property="carOil" column="CODE_HNAME"/>
		<result property="mileage" column="AUC_CAR_DRV_DIS"/>
		<result property="gear" column="CAR_TRANS_GB_NM"/>
		<result property="estimatedCost" column="BID_PLN_PRICE"/>
		<result property="bidCnt" column="BID_CNT"/>
		<result property="bidRegDate" column="ENTRY_DATE"/>
		<result property="bidClosDate" column="BID_EXP_DT"/>
		<result property="regMemNm" column="USER_NM"/>
		
		<!-- 필수 파라미터 -->
		<result property="sessionId" column="SESSION_ID"/>
		<result property="sessionIp" column="SESSION_IP"/>
	</resultMap>
	
	<!-- Retrieve : 회원관리 목록 조회 -->
	<select id="userInfListSelect" parameterType="egovframework.carauction.UserInfVO" resultMap="UserInfVO">
		<![CDATA[
		select ROW_NUMBER() OVER (ORDER BY A.ENTRY_DATE desc, A.USER_ID) AS NUM /* 순번 */
		     , (
		        select CMM.CODE_HNAME
		        from   CA_CMM_CD CMM
		        where  CMM.CODE_FIRST = 'U'
		        and    CMM.CODE_SECOND = '01'
		        and    CMM.CODE_NO = A.USER_GB_CD
		        ) as USER_GB_NM /* 사용자구분명 */
		     , A.USER_NM as USER_NM /* 사용자명 */
		     , A.CONT_NM as CONT_NM /* 담당자명 */
		     , A.CONT_CELLNO as CONT_CELLNO /* 담당자 휴대전화번호 */
		     , A.COMP_ADDR as COMP_ADDR /* 회사주소 */
		     , A.COMP_TELNO as COMP_TELNO /* 회사전화번호 */
		     , (
		        select COUNT(1)
		        from   CA_CAR_AUC_INF CAI
		        where  CAI.ENTRY_IDNO = A.USER_ID
		        ) as AUC_ENTRY_CNT /* 경매등록건수 */
		     , (
		        select COUNT(1)
		        from   CA_CAR_AUC_INF CAI
		        where  CAI.ENTRY_IDNO = A.USER_ID
		        and    CAI.AUC_PROG_YN = 'Y'
		        ) as AUC_BID_PROG_CNT /* 경매입찰진행건수 */
		     , (
		        select COUNT(1)
		        from   CA_CAR_AUC_INF CAI
		        where  CAI.ENTRY_IDNO = A.USER_ID
		        and    CAI.SBID_DATE is not NULL
		        ) as AUC_SBID_CNT /* 경매낙찰건수 */
		     , (
		        select COUNT(1)
		        from   CA_CAR_AUC_DTL_BID_INF CAD
		        where  CAD.ENTRY_IDNO = A.USER_ID
		        ) as BID_ENTRY_CNT /* 입찰등록건수 */
		     , (
		        select COUNT(1)
		        from   CA_CAR_AUC_DTL_BID_INF CAD
		        where  CAD.ENTRY_IDNO = A.USER_ID
		        and    CAD.SBID_YN = 'Y'
		        ) as BID_SBID_CNT /* 입찰낙찰건수 */
		     , TO_CHAR(A.ENTRY_DATE, 'YYYYMMDD') AS REG_DATE /* 가입일자 */
		     , A.USER_ID AS USER_ID /* 사용자ID */
		from   CA_USER_INF A /* 회원관리 */
		where  A.USER_ID IS NOT NULL
		]]>
		<!-- 가입일자기간 -->
		<if test="inStartDate != null and inStartDate != '' and inEndDate != null and inEndDate != ''">
		AND	TO_CHAR(A.ENTRY_DATE, 'YYYYMMDD') BETWEEN #{inStartDate} AND #{inEndDate}
		</if>
		<!-- 회원구분 -->
		<if test="inUserGbCd != null and inUserGbCd != ''">
		AND A.USER_GB_CD IN (${inUserGbCd})
		</if>
		<!-- 회원명 -->
		<if test="inUserNm != null and inUserNm != ''">
		AND A.USER_NM LIKE CONCAT('%', #{inUserNm}, '%')
		</if>
		ORDER BY NUM
	</select>

	<!-- Retrieve : 회원 수정 모달 정보 조회 -->
	<select id="userInfUpdateModalDataSelect" parameterType="egovframework.carauction.UserInfVO" resultMap="UserInfVO">
		<![CDATA[
		select (
		        select CMM.CODE_HNAME
		        from   CA_CMM_CD CMM
		        where  CMM.CODE_FIRST = 'U'
		        and    CMM.CODE_SECOND = '01'
		        and    CMM.CODE_NO = A.USER_GB_CD
		        ) as USER_GB_NM /* 사용자구분명 */
		     , A.USER_NM as USER_NM /* 사용자명 */
		     , A.CONT_NM as CONT_NM /* 담당자명 */
		     , A.CONT_CELLNO as CONT_CELLNO /* 담당자 휴대전화번호 */
		     , A.CONT_EMAIL_ADDR AS CONT_EMAIL_ADDR /* 담당자 이메일 주소 */
		     , A.COMP_ADDR as COMP_ADDR /* 회사주소 */
		     , A.COMP_TELNO as COMP_TELNO /* 회사전화번호 */
		     , A.COMP_FAXNO AS COMP_FAXNO /* 회사팩스번호 */
		     , A.COMP_HMPG_ADDR AS COMP_HMPG_ADDR /* 회사홈페이지주소 */
		     , TO_CHAR(A.ENTRY_DATE, 'YYYYMMDD') AS REG_DATE /* 가입일자 */
		     , A.REFD_BANK AS REFD_BANK /* 환불은행 */
		     , A.REFD_ACC AS REFD_ACC /* 환불계좌번호 */
		     , A.REFD_ACC_AHDR_NM AS REFD_ACC_AHDR_NM /* 환불계좌예금주명 */
		     , A.USER_ID AS USER_ID /* 사용자ID */
		     /*, A.USER_PW AS USER_PW*/ /* 사용자비밀번호 */
		from   CA_USER_INF A /* 회원관리 */
		where  A.USER_ID = #{inUserId}
		]]>
	</select>
	
	<!-- Update : 사용자 비밀번호 초기화 -->
	<update id="userInfPwInitUpdate" parameterType="egovframework.carauction.UserInfVO">
		<![CDATA[
		UPDATE	CA_USER_INF /* 회원관리 */
		SET		USER_PW = #{inUserPw}
			  , UPDAT_DATE = CURRENT_TIMESTAMP /* 수정일시 */
			  , UPDAT_IDNO = #{sessionId} /* 수정자ID */
		WHERE	USER_ID = #{inUserId}
		]]>
	</update>
	
	<!-- Retrieve : 회원관리 회원 현황 조회 -->
	<select id="userUseCntInfList" parameterType="egovframework.carauction.UserInfVO" resultMap="UserInfVO">
		<![CDATA[
			SELECT ROW_NUMBER() OVER (ORDER BY AUC.ENTRY_DATE DESC, AUC.CAR_NO DESC) AS NUM /* 순번 */
				, AUC.CAR_NO		/* 차량번호 */
				, CONCAT(CMM_CAR.CODE_HNAME, ' ', CAR.CAR_MODEL_NM) AS CAR_NM/* 차량명 */
				, AUC.AUC_CAR_CMNT /* 옵션내용 */
				, AUC.AUC_CAR_MAKE_YR /* 연식 */
				, CMM.CODE_HNAME /* 연료명 */
				, AUC.AUC_CAR_DRV_DIS /* 주행거리 */
				, CASE WHEN AUC.CAR_TRANS_GB = 'A'THEN '오토'
						ELSE '수동' END CAR_TRANS_GB_NM /* 변속기명 */
				, AUC.BID_PLN_PRICE /* 예정가 */
				, AUC.BID_CNT /* 입찰건수 */
				, TO_CHAR(AUC.ENTRY_DATE, 'YYYYMMDD') ENTRY_DATE /* 경매등록일 */
				, TO_CHAR(AUC.BID_EXP_DT, 'YYYYMMDD') BID_EXP_DT /* 경매마감일 */
				, USER.USER_NM /* 사용자명 */
			FROM CA_CAR_AUC_INF AUC
			INNER JOIN CA_CAR_INF CAR ON AUC.CAR_MAIN_NO = CAR.CAR_MAIN_NO
			INNER JOIN CA_USER_INF USER ON AUC.ENTRY_IDNO = USER.USER_ID
			INNER JOIN CA_CMM_CD CMM ON AUC.CAR_ENG_CD = CMM.CODE_NO
									AND CMM.CODE_FIRST = 'C'
									AND CMM.CODE_SECOND = '04'
									AND CMM.CODE_USEYN = 'Y'
			INNER JOIN CA_CMM_CD CMM_CAR ON CAR.MKR_CD = CMM_CAR.CODE_NO
									AND CMM_CAR.CODE_FIRST = 'C'
									AND CMM_CAR.CODE_SECOND = '01'
									AND CMM_CAR.CODE_USEYN = 'Y'
			WHERE AUC.ENTRY_IDNO = #{inSearchUserId}
		]]>
		<!-- 등록일 -->
		<if test="inRegStartDate != null and inRegStartDate != '' and inRegEndDate != null and inRegEndDate != ''">
			AND	TO_CHAR(AUC.ENTRY_DATE, 'YYYYMMDD') BETWEEN #{inRegStartDate} AND #{inRegEndDate}
		</if>
		ORDER BY NUM, AUC.AUC_REG_NO
	</select>
	
</mapper>